(()=>{"use strict";var e={8366:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.configAPI=void 0;const o=a(n(6860)),i=n(698),s=n(7665);t.configAPI=()=>{const e=(0,o.default)();return e.use(o.default.json()),e.post("/api/changeStatus",((e,t)=>r(void 0,void 0,void 0,(function*(){console.log("received webhook",e.body),t.sendStatus(200);const n=e.body.status,r=(yield s.bot.context.dbOrders.find({fp_id:Number(e.body.order_id)}).toArray())[0],a=r._id;"получен"!==r.status&&a&&("19"===n&&(yield(0,i.changeStatus)({orderNumber:a,status:3})),"20"===n&&(yield(0,i.changeStatus)({orderNumber:a,status:4})),"10"===n&&(yield(0,i.changeStatus)({orderNumber:a,status:5})))})))),e.post("/api/test",((e,t)=>{t.sendStatus(200)})),e}},6189:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.configDocsOrderBot=t.doc=void 0;const a=n(421);t.doc=new a.GoogleSpreadsheet("1TJk0s-S6IOYLuMlfe5rO7px5stv0EkzOANoOayqMdlU"),t.configDocsOrderBot=e=>r(void 0,void 0,void 0,(function*(){yield t.doc.useServiceAccountAuth({client_email:process.env.GOOGLE_SERVICE_ACCOUNT_EMAIL,private_key:process.env.GOOGLE_PRIVATE_KEY.replace(/\\n/g,"\n")}),yield t.doc.loadInfo();const n=t.doc.sheetsByIndex[0],r=t.doc.sheetsByIndex[3];e.context.google=n,e.context.googleStopList=r}))},7982:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.mongodbConnect=void 0,n(1081);const a=new(n(8013).MongoClient)(process.env.MONGODB_URI);t.mongodbConnect=()=>r(void 0,void 0,void 0,(function*(){return yield a.connect(),console.log(">>> MongoDB session connection successfully"),a.db(process.env.MONGODB_DB)}))},7665:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.bot=t.configOrderBot=void 0,n(1081);const r=n(832),a=n(8264),o=n(2733),i=n(9704),s=n(7130),d=n(3175),c=n(3121),u=n(6189),l=new r.Telegraf(process.env.BOT_TOKEN);t.bot=l,t.configOrderBot=e=>(l.use((0,a.session)(e,{sessionName:"session",collectionName:"sessions"})),l.context.config=e.collection("config"),l.context.dbSession=e.collection("sessions"),l.context.dbRestaurants=e.collection("restaurants"),l.context.dbOrders=e.collection("orders"),l.context.dbMenuConfig=e.collection("menu_config"),(0,s.setupI18n)(l),(0,d.panels)(l),l.use(c.ScenesStage.middleware()),(0,o.composers)(l),(0,u.configDocsOrderBot)(l),(0,i.configCron)(l),l.catch((e=>{console.error(e)})),l)},2018:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.supBot=t.configSupportBot=void 0,n(1081);const a=n(832),o=n(8264),i=n(7847),s=n(2993),d=n(669),c=n(8266),u=new a.Telegraf(process.env.SUPPORT_BOT_TOKEN);t.supBot=u,t.configSupportBot=e=>(u.use((0,o.session)(e,{sessionName:"session",collectionName:"sessionsSupport"})),u.context.originalSession=e.collection("sessions"),u.context.supSession=e.collection("sessionsSupport"),u.context.tickets=e.collection("tickets"),u.use(d.ScenesStage.middleware()),(0,s.setupI18sup)(u),(0,i.composers)(u),u.catch((e=>{console.error(e)})),u.on("message",(e=>r(void 0,void 0,void 0,(function*(){if(-799674066==e.chat.id){if("/close"===e.message.text){if(e.message.reply_to_message)if(e.message.reply_to_message.forward_from){const t=(yield e.supSession.find({key:e.message.reply_to_message.forward_from.id+":"+e.message.reply_to_message.forward_from.id}).toArray())[0].data;t.ticket?(yield e.tickets.updateOne({_id:t.ticket},{$set:{status:"close"}}),e.telegram.sendMessage(e.message.reply_to_message.forward_from.id,"<b>Чат-обращение закрыл оператор</b>\n\nЕсли не согласны с последним ответом - можете открыть новое обращение прямо сейчас! /start",{parse_mode:"HTML"}),e.replyWithHTML(`Обращение <code>${t.ticket}</code> успешно закрыто!`),yield e.tickets.updateOne({_id:t.ticket},{$push:{messages:{sender:e.from.first_name,message:"Закрыл обращение",mid:0}}}),yield e.supSession.updateOne({key:e.message.reply_to_message.forward_from.id+":"+e.message.reply_to_message.forward_from.id},{$unset:{"data.ticket":""}})):e.replyWithHTML("Обращение закрыто ранее")}else if(5435674989===e.message.reply_to_message.from.id)if(e.message.reply_to_message.text.includes("Обращение #")){const[,t]=e.message.reply_to_message.text.split("#"),n=(yield e.tickets.find({_id:Number(t)}).toArray())[0];"open"===n.status?(yield e.tickets.updateOne({_id:t},{$set:{status:"close"}}),yield e.tickets.updateOne({_id:t},{$push:{messages:{sender:e.from.first_name,message:"Закрыл обращение",mid:0}}}),e.telegram.sendMessage(n.chatId,"<b>Чат-обращение закрыл оператор</b>\n\nЕсли не согласны с последним ответом - можете открыть новое обращение прямо сейчас! /start",{parse_mode:"HTML"}),e.replyWithHTML(`Обращение <code>${t}</code> успешно закрыто!`),yield e.supSession.updateOne({key:n.chatId+":"+n.chatId},{$unset:{"data.ticket":""}})):e.replyWithHTML("Обращение закрыто ранее.")}else e.replyWithHTML("Обращение закрыто ранее или не существует.");return}if(~e.message.text.indexOf("/info")){const[,t]=e.message.text.split(" ");let n;if(t)n=(yield e.tickets.find({_id:Number(t)}).toArray())[0];else if(e.message.reply_to_message)if(e.message.reply_to_message.forward_from){const t=(yield e.supSession.find({key:e.message.reply_to_message.forward_from.id+":"+e.message.reply_to_message.forward_from.id}).toArray())[0].data;t.ticket&&(n=(yield e.tickets.find({_id:Number(t.ticket)}).toArray())[0])}else if(5435674989===e.message.reply_to_message.from.id&&e.message.reply_to_message.text.includes("Обращение #")){const[,t]=e.message.reply_to_message.text.split("#");n=(yield e.tickets.find({_id:Number(t)}).toArray())[0]}return void(n?e.replyWithHTML(`Информация о обращении\n\n<a href="tg://user?id=${n.chatId}">Клиент</a> начавший переписку\n\nИстория последних сообщений:`,Object.assign({},a.Markup.inlineKeyboard(c.supKeyboard.actions(n._id)))):e.replyWithHTML("Обращение не найдено. Если оно было закрыто, то воспользуйтесь: /info [номер обращения]"))}if(e.message.reply_to_message)if(e.message.reply_to_message.forward_from){const t=(yield e.supSession.find({key:e.message.reply_to_message.forward_from.id+":"+e.message.reply_to_message.forward_from.id}).toArray())[0].data;t.ticket?e.copyMessage(e.message.reply_to_message.forward_from.id).then((n=>r(void 0,void 0,void 0,(function*(){let r="";r=e.message.text?e.message.text:e.message.caption?e.message.caption+" +файл(-ы)":"файл(-ы)",yield e.tickets.updateOne({_id:t.ticket},{$push:{messages:{sender:e.from.first_name,message:r,mid:n.message_id}}})})))):e.replyWithHTML("Сообщение не отправлено. Обращение закрыто ранее.")}else if(5435674989===e.message.reply_to_message.from.id)if(e.message.reply_to_message.text.includes("Обращение #")){const[,t]=e.message.reply_to_message.text.split("#"),n=(yield e.tickets.find({_id:Number(t)}).toArray())[0];"open"===n.status?e.copyMessage(n.chatId).then((n=>r(void 0,void 0,void 0,(function*(){let r="";r=e.message.text?e.message.text:e.message.caption?e.message.caption+" +файл(-ы)":"файл(-ы)",yield e.tickets.updateOne({_id:Number(t)},{$push:{messages:{sender:e.from.first_name,message:r,mid:n.message_id}}})})))):e.replyWithHTML("Сообщение не отправлено. Обращение закрыто ранее.")}else e.replyWithHTML("Сообщение не отправлено. Обращение закрыто ранее или не существует.")}})))),u.action(/^lm\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t]=e.callbackQuery.data.split(":"),n=(yield e.tickets.find({_id:Number(t)}).toArray())[0];let r=0,a=[];console.log(e.callbackQuery.data);for(let e=n.messages.length-1;e>=0;e--){let t=n.messages[e].sender+": "+n.messages[e].message;if(r+=t.length+2,r>200)break;a.unshift(t)}yield e.answerCbQuery(a.join("\n"),{show_alert:!0})}catch(e){console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u)},7726:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(698),i=n(9042),s=new a.Composer;s.command("cst",(e=>r(void 0,void 0,void 0,(function*(){try{if(yield e.deleteMessage(),(yield(0,i.getAdminLvl)(e.from.id))<1)return;const[,t,n]=e.message.text.trim().split(" ");/^[0-9]{6}-[0-9]{6}/.test(t)&&Number(n)>=2&&Number(n)<=7&&(yield(0,o.changeStatus)({status:Number(n),orderNumber:t}),e.replyWithHTML(`Статус заказа <b>${t}</b> изменён!`))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=s},6412:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(9042),i=new a.Composer;i.command("ban",(e=>r(void 0,void 0,void 0,(function*(){try{if(yield e.deleteMessage(),!e.from)return;if((yield(0,o.getAdminLvl)(e.from.id))<2)return;const[,t,...n]=e.message.text.trim().split(" ");if(!t)return;if(!/[0-9]{10}/.test(t))return;if(10!==t.length)return;return yield e.config.updateOne({name:"ban-list"},{$push:{data:{phone:"7"+t,comment:n?n.join(" "):""}}}),yield e.replyWithHTML(`<b>${"+7"+t}</b> добавлен(а) в чёрный список ${n?"с комментарием: <i>"+n.join(" ")+"</i>":""}`)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),i.command("unban",(e=>r(void 0,void 0,void 0,(function*(){try{if(yield e.deleteMessage(),!e.from)return;if((yield(0,o.getAdminLvl)(e.from.id))<2)return;const t=e.message.text.trim().split(" ");if(1===t.length)return;if(t.length>2)return;if(!/[0-9]{10}/.test(t[1]))return;if(10!==t[1].length)return;return yield e.config.updateOne({name:"ban-list"},{$pull:{data:{phone:"7"+t[1]}}}),yield e.replyWithHTML(`<b>${"+7"+t[1]}</b> убран(а) из чёрного списка`)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),i.command("banlist",(e=>r(void 0,void 0,void 0,(function*(){try{if(yield e.deleteMessage(),!e.from)return;if((yield(0,o.getAdminLvl)(e.from.id))<2)return;const t=(yield e.config.find({name:"ban-list"}).toArray())[0];let n="<b>Список заблокированных пользователей:</b>\n\n";return t.data.forEach((e=>{const[t,...r]=e.phone;n+=`<b><code>${r.join("")}</code></b> - <i>${e.comment}</i>`})),yield e.replyWithHTML(n)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=i},9890:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(2167)),i=a(n(8941)),s=n(832),d=n(6968),c=n(9184),u=n(9042),l=n(5303),p=n(8370),m=e=>new Promise((t=>setTimeout(t,e))),y=new s.Composer;y.on("message",(e=>r(void 0,void 0,void 0,(function*(){try{if(e.chat.id>0)return yield e.deleteMessage(e.message.message_id);if(e.chat.id===Number(process.env.MAILING_CHAT))if("/sendall"===e.message.text){if(e.message.reply_to_message){if((yield(0,u.getAdminLvl)(e.from.id))<2)return;const t=yield e.dbSession.find({}).toArray();yield e.replyWithHTML("Рассылка началась. <b>~"+t.length+"</b> клиентов участвуют в рассылке. Точное количество будет отражено в конце рассылки");let n=0,r=0,a=0;for(const o of t)if(o.key){const[t,i]=o.key.split(":");if(t===i){try{yield e.telegram.copyMessage(t,Number(process.env.MAILING_CHAT),e.message.reply_to_message.message_id),n++}catch(e){console.log(t,"запретил(а) боту писать сообщения"),r++}try{yield m(1e4)}catch(e){console.log(e)}}else a++}yield e.replyWithHTML(`<b>Рассылка окончена</b>\n\nРазослано <b>${n}</b> сообщений, которые были получены\n<b>${a}</b> пользователей оказались невалидными\n<b>${r}</b> пользователей остановили бота`)}}else if(~e.message.text.indexOf("/sendfb "))if(e.message.reply_to_message){const[,...t]=e.message.text.split(" ");if(t.length>0)for(const n of t){const t=(yield e.dbSession.find({"data.phone":n}).toArray())[0];if(t)if(t.key){const[r]=t.key.split(":");try{yield e.telegram.copyMessage(r,Number(process.env.MAILING_CHAT),e.message.reply_to_message.message_id,Object.assign({},s.Markup.inlineKeyboard([s.Markup.button.url("Перейти в поддержку","https://t.me/bostonsupportbot")]))),e.reply("Пользователю "+n+" доставлено сообщение")}catch(t){console.log(r,"запретил(а) боту писать сообщения",t),e.reply("Пользователь "+n+" запретил писать боту")}try{yield m(1e3)}catch(e){console.log(e)}}else e.reply("Пользователь "+n+" не пользуется ботом");else e.reply("Пользователь "+n+" не пользуется ботом")}else e.reply("Укажите пользователей через пробел /send 79519335990")}else e.reply("Не выделено сообщение или выделено старое сообщение");else if(~e.message.text.indexOf("/sendad "))if(e.message.reply_to_message){const[,...t]=e.message.text.split(" ");if(t.length>0)for(const n of t){const t=(yield e.dbSession.find({"data.phone":n}).toArray())[0];if(t.key){const[r]=t.key.split(":");try{yield e.telegram.copyMessage(r,Number(process.env.MAILING_CHAT),e.message.reply_to_message.message_id),e.reply("Пользователю "+n+" доставлено сообщение")}catch(t){console.log(r,"запретил(а) боту писать сообщения",t),e.reply("Пользователь "+n+" запретил писать боту")}try{yield m(1e3)}catch(e){console.log(e)}}else e.reply("Пользователь "+n+" не пользуется ботом")}else e.reply("Укажите пользователей через пробел /send 79519335990")}else e.reply("Не выделено сообщение или выделено старое сообщение")}catch(e){console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),y.action(/.+/,(e=>r(void 0,void 0,void 0,(function*(){try{if("newOrder"===e.callbackQuery.data)return yield e.panel.MainPanel(e);if(~e.callbackQuery.data.indexOf("repeatOrder:")){if(e.session.id_mes_panel)try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel),delete e.session.id_mes_panel}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML")),delete e.session.id_mes_panel}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}const[,t]=e.callbackQuery.data.split(":"),n=(yield e.dbOrders.find({_id:t}).toArray())[0];if(e.session.order=yield(0,p.updatePrices)(n.products,n.restaurant_id),(0,d.productsSum)(e.session.order)!==(0,d.productsSum)(n.products)&&(yield e.answerCbQuery("Внимание✋\n Цены, продукты или добавки в корзине изменились\n\nПроверьте изменения перед заказом",{show_alert:!0}),e.session.order.length<1))return delete e.session.order,yield e.panel.MainPanel(e);e.session.restaurant_id=n.restaurant_id;const a=(yield e.dbRestaurants.find({_id:n.restaurant_id}).toArray())[0].address;let u=0;const m=new i.default;m.append("secret",(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].frontPad),m.append("client_phone","8"+e.session.phone.toString().slice(1,11)),yield(0,o.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?get_client",data:m}).then((e=>r(void 0,void 0,void 0,(function*(){"success"===e.data.result&&(u=Number(e.data.score))}))));const y=[[l.keyboard.checkout.payInRestaurant]];return u>=(0,d.productsSum)(e.session.order)&&(e.session.last_bonus_write_off?e.session.last_bonus_write_off+432e5<(new Date).getTime()&&y.push([l.keyboard.checkout.payBonus(Math.floor(u),(0,d.productsSum)(e.session.order))]):y.push([l.keyboard.checkout.payBonus(Math.floor(u),(0,d.productsSum)(e.session.order))])),y.push([l.keyboard.checkout.return]),yield e.replyWithHTML(e.i18n.t("repeatOrder",{hat:e.i18n.t("hat"),address:a,take:n.take,products:(0,c.productsToString)(e.session.order),sum:(0,d.productsSum)(e.session.order)}),Object.assign({},s.Markup.inlineKeyboard(y))).then((t=>{e.session.id_mes_panel=t.message_id})),yield e.scene.enter("checkout"),e.wizard.state.data={take:n.take,time:"Как можно скорее",comment:n.comment},yield e.wizard.selectStep(6)}if(":"===e.callbackQuery.data)try{return yield e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}if(e.session.__scenes.current)try{return e.answerCbQuery(e.i18n.t("wait"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}yield e.answerCbQuery(e.i18n.t("error-answer"),{show_alert:!0}),yield e.panel.MainPanel(e)}catch(e){console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=y},4945:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=new(n(832).Composer);a.action(/^cancelOrd\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t]=e.callbackQuery.data.split(":"),n=t,r=(yield e.dbOrders.find({_id:n}).toArray())[0];r.status="отменён (до оплаты)",yield e.deleteMessage(),yield e.answerCbQuery(e.i18n.t("success"),{show_alert:!0}),yield e.dbOrders.updateOne({_id:r._id},{$set:r})}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=a},4206:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(698),i=new a.Composer;i.action(/^ordCS\:/,(e=>r(void 0,void 0,void 0,(function*(){try{yield e.answerCbQuery(e.i18n.t("loading"));const[,t,n]=e.callbackQuery.data.split(":"),r=n,a=(yield e.dbOrders.find({_id:r}).toArray())[0];"Accept"===t?yield(0,o.changeStatus)({orderNumber:a._id,status:3}):"Ready"===t?yield(0,o.changeStatus)({orderNumber:a._id,status:4}):"Placed"===t?yield(0,o.changeStatus)({orderNumber:a._id,status:5}):"Cancel"===t&&(yield(0,o.changeStatus)({orderNumber:a._id,status:6}))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=i},3466:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=new(n(832).Composer);a.command("help",(e=>r(void 0,void 0,void 0,(function*(){try{const t=(yield e.dbRestaurants.find({}).toArray()).map((e=>e.chat_id));return e.chat.id===Number(process.env.MAILING_CHAT)?e.replyWithHTML(e.i18n.t("help-mailing")):t.includes(e.chat.id)?e.replyWithHTML(e.i18n.t("help-restChat")):e.replyWithHTML(e.i18n.t("help"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=a},9146:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=new(n(832).Composer);a.action("hideThisMessage",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.deleteMessage()}catch(t){try{yield e.editMessageText('<span class="tg-spoiler">сообщение скрыто</span>',{parse_mode:"HTML"})}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,t)}})))),e.exports=a},2685:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=new(n(832).Composer);a.command("menu",(e=>r(void 0,void 0,void 0,(function*(){try{if(e.chat.id>0){try{yield e.telegram.deleteMessage(e.from.id,e.message.message_id)}catch(e){}yield e.panel.MainPanel(e)}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=a},1472:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(7665),i=new a.Composer;i.command("sparse",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.deleteMessage();const t=yield o.bot.context.dbRestaurants.find({}).toArray();if(t.map((e=>e.chat_id)).includes(e.chat.id)){const n=t.find((t=>t.chat_id===e.chat.id)),r=(yield o.bot.context.dbOrders.find({$and:[{date:(new Date).toLocaleDateString("ru")},{restaurant_id:n._id},{status:"получен"}]}).toArray()).filter((e=>e.changeStatusTime));if(!r.length)return e.replyWithHTML("Недостаточно заказов для формирования отчёта");const a=Math.floor(r.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.time.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.toCooking.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/r.length),i=Math.floor(a/60)+":"+(1===(a%60).toString().length?"0"+a%60:a%60),s=Math.floor(r.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.changeStatusTime.toCooking.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.toReady.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/r.length),d=Math.floor(s/60)+":"+(1===(s%60).toString().length?"0"+s%60:s%60),c=Math.floor(r.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.changeStatusTime.toReady.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.received.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/r.length),u=Math.floor(c/60)+":"+(1===(c%60).toString().length?"0"+c%60:c%60),l=`Сформирован отчёт по скорости за ${(new Date).toLocaleDateString("ru")}\n\nСреднее время принятия заказа: ${i}\nСреднее время приготовления заказа: ${d}\nОбщее среднее время от принятия до приготовления: <b>${Math.floor((a+s)/60)+":"+(1===((a+s)%60).toString().length?"0"+(a+s)%60:(a+s)%60)}</b>\n\nСреднее время выдачи заказа: ${u}`;yield e.replyWithHTML(l)}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),i.command("sparseM",(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n]=e.message.text.trim().split(" ");yield e.deleteMessage();const r=(yield o.bot.context.dbRestaurants.find({}).toArray()).find((e=>e._id===Number(t)));let a=[];for(let e=1;e<=33;e++)a=[...a,...yield o.bot.context.dbOrders.find({$and:[{date:`${e}.${n}`},{restaurant_id:r._id},{status:"получен"}]}).toArray()];const i=a.filter((e=>e.changeStatusTime));if(!i.length)return e.replyWithHTML("Недостаточно заказов для формирования отчёта");const s=Math.floor(i.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.time.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.toCooking.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/i.length),d=Math.floor(s/60)+":"+(1===(s%60).toString().length?"0"+s%60:s%60),c=Math.floor(i.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.changeStatusTime.toCooking.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.toReady.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/i.length),u=Math.floor(c/60)+":"+(1===(c%60).toString().length?"0"+c%60:c%60),l=Math.floor(i.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.changeStatusTime.toReady.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.received.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/i.length),p=Math.floor(l/60)+":"+(1===(l%60).toString().length?"0"+l%60:l%60),m=`Месячный отчёт по скорости за ${n} для ${null==r?void 0:r.address}\n\nЗаказов со статусом "получен": ${a.length}\n\nСреднее время принятия заказа: ${d}\nСреднее время приготовления заказа: ${u}\nОбщее среднее время от принятия до приготовления: <b>${Math.floor((s+c)/60)+":"+(1===((s+c)%60).toString().length?"0"+(s+c)%60:(s+c)%60)}</b>\n\nСреднее время выдачи заказа: ${p}`;yield e.replyWithHTML(m)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=i},6578:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(2387),i=new a.Composer;i.on("pre_checkout_query",(e=>r(void 0,void 0,void 0,(function*(){try{const t=JSON.parse(e.preCheckoutQuery.invoice_payload)._id,n=(yield e.dbOrders.find({_id:t}).toArray())[0],r=(yield e.dbRestaurants.find({_id:n.restaurant_id}).toArray())[0],a=(new Date).getHours();if(a>=r.workingHours.start&&a<r.workingHours.end){const[t,r]=n.time.split(":"),[a,o,i]=n.date.split("."),s=new Date(Number(i),Number(o)-1,Number(a),Number(t),Number(r));console.log((new Date).toLocaleTimeString(),new Date(s.getTime()+12e5).toLocaleTimeString()),new Date<new Date(s.getTime()+12e5)?yield e.answerPreCheckoutQuery(!0):yield e.answerPreCheckoutQuery(!1,"❗️ Вы пытаетесь оплатить старый чек ❗️ Оплатить заказ можно в течении 20 минут после создания чека")}else yield e.answerPreCheckoutQuery(!1,"❗️ Ресторан сейчас закрыт ❗️ Ждём заказ от вас в рабочее время ресторана!")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),i.on("successful_payment",((e,t)=>r(void 0,void 0,void 0,(function*(){try{const t=JSON.parse(e.message.successful_payment.invoice_payload)._id,n=(yield e.dbOrders.find({_id:t}).toArray())[0];yield(0,o.sendOrder)(e,n)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=i},4315:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(8013),o=n(832),i=n(5303),s=new o.Composer;s.action(/^rateOrder\:/,(e=>r(void 0,void 0,void 0,(function*(){try{try{yield e.deleteMessage()}catch(t){try{yield e.telegram.editMessageText(e.callbackQuery.message.chat.id,e.callbackQuery.message.message_id,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}console.error(`Cant del err >> ${__filename} error:`,t)}const[,t,n]=e.callbackQuery.data.split(":");yield e.replyWithHTML(e.i18n.t(Number(t)<5?Number(t)<4?"rate-noLike":"rate-soSo":"rate-like"),Object.assign({},o.Markup.inlineKeyboard(i.keyboard.rate.rate_br([],Number(t))))).then((o=>{e.session.mid=o.message_id,setTimeout((()=>r(void 0,void 0,void 0,(function*(){var o;let i=!1,s="";n.includes("-")?s=n:(s=new a.ObjectId(n),i=!0);const d=(yield e.dbOrders.find({_id:s}).toArray())[0];if(d.rate)return;const c=(yield e.dbRestaurants.find({_id:d.restaurant_id}).toArray())[0];d.rate={grade:Number(t),caus:"",comment:""},((null===(o=d.rate)||void 0===o?void 0:o.comment.length)||d.rate.grade<4)&&(yield e.telegram.sendMessage(c.rate_chat_id,e.i18n.t("rate-toChat",{order:d,restaurant:c}),{parse_mode:"HTML"}).then((t=>r(void 0,void 0,void 0,(function*(){if(d.rate.grade<4)try{yield e.telegram.pinChatMessage(t.chat.id,t.message_id)}catch(e){console.error("pinErr",e)}})))));try{yield e.telegram.editMessageText(e.from.id,e.session.mid,"",e.i18n.t("rate-thankYou"))}catch(e){}yield e.google.addRow({date:d.date+" "+d.time,order:i?d._id.toString():d._id,grade:d.rate.grade,br:"",comment:"",photo:"",client:d.client.number,restaurant:c.address,fp_number:d.fp_number?d.fp_number:""}),yield e.dbOrders.updateOne({_id:d._id},{$set:d}),delete e.session.mid}))),72e5)})),yield e.scene.enter("rateOrder",{data:{_id:n,grade:Number(t),caus:[]}})}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=s},6808:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=new(n(832).Composer);e.exports=r},8887:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=new(n(832).Composer);a.start((e=>r(void 0,void 0,void 0,(function*(){try{if(e.message&&e.chat){if(e.chat.id<0)return;try{yield e.telegram.deleteMessage(e.message.chat.id,e.message.message_id)}catch(e){}return e.session.id_mes_panel?yield e.panel.MainPanel(e):yield e.panel.RegisterPanel(e)}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=a},4774:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=new(n(832).Composer);a.command("test3",(e=>r(void 0,void 0,void 0,(function*(){try{console.log(e.chat)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=a},2733:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.composers=void 0,t.composers=e=>{e.use(n(8887)),e.use(n(1472)),e.use(n(2685)),e.use(n(3466)),e.use(n(4206)),e.use(n(6578)),e.use(n(4315)),e.use(n(4945)),e.use(n(9146)),e.use(n(6412)),e.use(n(7726)),e.use(n(4774)),e.use(n(6808)),e.use(n(9890))}},9704:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.configCron=void 0;const o=n(832),i=a(n(8311)),s=n(6968),d=n(2387),c=n(5303),u=n(6027);t.configCron=e=>{i.default.schedule("*/30 * * * *",(()=>r(void 0,void 0,void 0,(function*(){const t=yield e.context.dbRestaurants.find({}).toArray();for(let n of t){const t=yield e.context.dbOrders.find({$and:[{date:(new Date).toLocaleDateString("ru")},{restaurant_id:n._id}]}).toArray();if(t.length){const r=t.filter((e=>{const[t,n]=e.time.split(":");return Number(t)!==(new Date).getHours()&&!(Number(t)+1===(new Date).getHours()&&(new Date).getMinutes()<30&&Number(n)>=30)&&"получен"!==e.status&&"отменён"!==e.status&&"отменён (до оплаты)"!==e.status&&"ожидает оплаты"!==e.status&&"оформлен (ожидание)"!==e.status}));if(r.length){let t="<b>Есть незакрытые заказы:</b>\n\n";t+=r.map((e=>`#${e._id} ${e.status} | приготовить ${e.cookingTime}`)).join("\n"),t+="\n\nпроверьте данные заказы и закреплённые сообщения",yield e.telegram.sendMessage(n.chat_id,t,Object.assign({parse_mode:"HTML"},o.Markup.inlineKeyboard([c.keyboard.hideThisMessage])))}}}})))),i.default.schedule("20 */5 * * * *",(()=>r(void 0,void 0,void 0,(function*(){const t=yield e.context.dbRestaurants.find({}).toArray();for(let n of t){const t=yield e.context.dbOrders.find({$and:[{date:(new Date).toLocaleDateString("ru")},{restaurant_id:n._id},{status:"оформлен (ожидание)"}]}).toArray();t.length&&t.forEach((t=>{const n=(0,s.productsSum)(t.products),r=n<1e3?30:n<2e3?40:60,[a,o,i]=t.date.split("."),[c,u]=t.cookingTime.split(":");return new Date(Number(i),Number(o)-1,Number(a),Number(c),Number(u)).getTime()<=(new Date).getTime()+6e4*r&&(0,d.sendOrder)(e.context,t,e)}))}})))),(0,u.reports)(),i.default.schedule("5 12 * * *",(()=>r(void 0,void 0,void 0,(function*(){const t=yield e.context.dbRestaurants.find({}).toArray(),n=/^990/;for(const r of t){const t=r.products.filter((e=>e.stop&&!n.test(e.product_id)));if(console.log(t),t.length>0){let n="<b>Напоминание о стоп-листе</b>\n\nВ данный момент в стоп-листе следующие продукты:\n\n";t.forEach((e=>n+="<i>"+e.name+"</i>\n")),n+="\nЕсли продукты уже доступны, то необходимо вынести их из <b>стоп-листа</b>",e.telegram.sendMessage(r.rate_chat_id,n,Object.assign({parse_mode:"HTML"},o.Markup.inlineKeyboard([c.keyboard.hideThisMessage])))}}}))))}},7130:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.setupI18n=void 0;const a=r(n(1017)),o=new(r(n(6761)).default)({directory:a.default.resolve(__dirname,"../locales"),useSession:!1,allowMissing:!1,defaultLanguage:"ru"});t.setupI18n=e=>{e.use(o.middleware())}},3175:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.panels=void 0;const r=n(6606),a=n(5189),o=n(1978),i=n(3297),s=n(5116),d=n(2338);t.panels=e=>{e.context.panel={},e.context.panel.RegisterPanel=d.RegisterPanel,e.context.panel.MainPanel=r.MainPanel,e.context.panel.MenuPanel=i.MenuPanel,e.context.panel.OrderPanel=s.OrderPanel,e.context.panel.AddBonusAccountPanel=a.AddBonusAccountPanel,e.context.panel.AdminPanel=o.AdminPanel}},6027:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.reports=void 0;const a=n(7665),o=n(1140);t.reports=()=>r(void 0,void 0,void 0,(function*(){const e=yield a.bot.context.dbRestaurants.find({}).toArray();for(let t of e)yield(0,o.getRestReport)(t,a.bot)}))},3121:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ScenesStage=void 0;const r=n(832);t.ScenesStage=new r.Scenes.Stage([n(989),n(7264),n(3818),n(5609),n(351),n(3076),n(4916)])},3076:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(2167)),i=a(n(8941)),s=n(832),d=n(8542),c=n(5303),u=n(7665),l=new s.Composer;l.action("adminParseMenuA",(e=>r(void 0,void 0,void 0,(function*(){try{const t=[[c.keyboard.back]],n=(yield u.bot.context.config.find({name:"admins"}).toArray())[0].data.find((t=>t.chatId===e.from.id));return(yield e.dbRestaurants.find(void 0!==n.only?{_id:n.only}:{}).toArray()).map((e=>{t.push([s.Markup.button.callback(e.address,"parse:"+e._id)])})),yield e.editMessageText(e.i18n.t("adminPanel-parse-choiceRestaurant",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(t))),e.answerCbQuery(),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),l.action("changeWorkTimeA",(e=>r(void 0,void 0,void 0,(function*(){try{const t=[[c.keyboard.back]],n=(yield u.bot.context.config.find({name:"admins"}).toArray())[0].data.find((t=>t.chatId===e.from.id));return(yield e.dbRestaurants.find(void 0!==n.only?{_id:n.only}:{}).toArray()).map((e=>{t.push([s.Markup.button.callback(e.address,`changeTime:${e.workingHours.start}:${e.workingHours.end}:+${e._id}`)])})),yield e.editMessageText(e.i18n.t("adminPanel-changeWorkTime-choiceRestaurant",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(t))),e.answerCbQuery(),yield e.wizard.selectStep(2)}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}})))),l.action("stopRestA",(e=>r(void 0,void 0,void 0,(function*(){try{const t=[[c.keyboard.backT]],n=(yield u.bot.context.config.find({name:"admins"}).toArray())[0].data.find((t=>t.chatId===e.from.id));return(yield e.dbRestaurants.find(void 0!==n.only?{_id:n.only}:{}).toArray()).map((e=>{e.isStop.length>0?t.push([s.Markup.button.callback("🔴 "+e.address,`unStopRest:${e._id}`)]):t.push([s.Markup.button.callback("🟢 "+e.address,`stopRest:${e._id}`)])})),yield e.editMessageText(e.i18n.t("adminPanel-stopRest-choiceRestaurant",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(t))),e.answerCbQuery(),yield e.wizard.selectStep(4)}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}})))),l.action("stopListA",(e=>r(void 0,void 0,void 0,(function*(){try{const t=[[c.keyboard.backT]],n=(yield u.bot.context.config.find({name:"admins"}).toArray())[0].data.find((t=>t.chatId===e.from.id));return(yield e.dbRestaurants.find(void 0!==n.only?{_id:n.only}:{}).toArray()).map((e=>{t.push([s.Markup.button.callback(e.address,`stopListMenu:${e._id}`)])})),yield e.editMessageText(e.i18n.t("adminPanel-stopList-choiceRestaurant",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(t))),e.answerCbQuery(),yield e.wizard.selectStep(3)}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}})))),l.action("back",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MainPanel(e,!0),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}}))));const p=new s.Composer;p.action(/^parse\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t]=e.callbackQuery.data.split(":"),n=new i.default;n.append("secret",(yield e.dbRestaurants.find({_id:Number(t)}).toArray())[0].frontPad),(0,o.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?get_products",data:n}).then((n=>r(void 0,void 0,void 0,(function*(){const r=n.data,a=[],o=yield e.dbMenuConfig.find({}).toArray(),i=/^909/,s=/^990/;for(let e in r.product_id)if(i.test(r.product_id[e])){const t=o.find((t=>t.product_id===r.product_id[e]));t?a.push({product_id:r.product_id[e],name:r.name[e],price:Number(r.price[e]),stop:!1,description:t.description,additivesProducts:t.additivesProducts,exceptionsProducts:t.exceptionsProducts}):a.push({product_id:r.product_id[e],name:r.name[e],price:Number(r.price[e]),stop:!1})}else s.test(r.product_id[e])&&a.push({product_id:r.product_id[e],name:r.name[e],price:Number(r.price[e]),stop:!0});yield e.dbRestaurants.updateOne({_id:Number(t)},{$set:{products:a,lastUpdate:`${(new Date).toLocaleDateString("ru")} ${(new Date).toLocaleTimeString("ru")}`}});try{e.answerCbQuery(e.i18n.t("success"),{show_alert:!0})}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),p.action("back",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MainPanel(e,!0),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const m=new s.Composer;m.action(/^changeTime\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n,r]=e.callbackQuery.data.split(":"),a={start:Number(t),end:Number(n),restId:Number(r)};yield e.editMessageText(e.i18n.t("adminPanel-changeWorkTime-choiceTime",{hat:e.i18n.t("hat"),props:a}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(c.keyboard.adminPanel.workingTime(a)))),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),m.action(/^save\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n,r]=e.callbackQuery.data.split(":"),a={start:Number(t),end:Number(n)};return yield e.dbRestaurants.updateOne({_id:Number(r)},{$set:{workingHours:a}}),yield e.answerCbQuery(e.i18n.t("success"),{show_alert:!0}),yield e.panel.MainPanel(e,!0)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const y=new s.Composer;y.action(/^stopListMenu\:/,(e=>r(void 0,void 0,void 0,(function*(){try{e.wizard.state.data={restId:e.callbackQuery.data.split(":")[1]};const t=(yield e.config.find({name:"categories"}).toArray())[0].data,n=(0,d.CreateMultilineKeyboard)(t,"stopCat","id",2,"name"),r=[];n.map((e=>{r.push(e)})),e.session.order?r.push([c.keyboard.order(e),c.keyboard.back]):r.push([c.keyboard.backT]),yield e.editMessageText(e.i18n.t("adminPanel-stopList-category",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(r)))}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}})))),y.action(/^stopCat\:/,(e=>r(void 0,void 0,void 0,(function*(){var t,n;try{if(e.callbackQuery&&e.callbackQuery.data){const[,r,a]=e.callbackQuery.data.split(":"),o=[],i=(yield e.config.find({name:"categories"}).toArray())[0].data.find((e=>e.id===Number(r))),d=(yield e.dbRestaurants.find({_id:Number(e.wizard.state.data.restId)}).toArray())[0].products;a&&(d[Number(a)].stop?(yield e.dbRestaurants.updateOne({_id:Number(e.wizard.state.data.restId)},{$set:{["products."+a+".stop"]:!1}}),yield e.googleStopList.addRow({date:(new Date).toLocaleString("ru"),restaurant:e.wizard.state.data.restId,action:`Продукт "${d[Number(a)].name}" УБРАН из стоп-лист`,user:null!==(t=e.from.username)&&void 0!==t?t:e.from.first_name})):(yield e.dbRestaurants.updateOne({_id:Number(e.wizard.state.data.restId)},{$set:{["products."+a+".stop"]:!0}}),yield e.googleStopList.addRow({date:(new Date).toLocaleString("ru"),restaurant:e.wizard.state.data.restId,action:`Продукт "${d[Number(a)].name}" ДОБАВЛЕН в стоп-листа`,user:null!==(n=e.from.username)&&void 0!==n?n:e.from.first_name})));const u=(yield e.dbRestaurants.find({_id:Number(e.wizard.state.data.restId)}).toArray())[0].products,l=Object.assign({},u);for(let e in l){let t=0;for(let n of i.indexes)t>0||-1===l[e].name.toLowerCase().indexOf(n.toLowerCase())||++t;0!==t&&(l[e].stop?o.push([s.Markup.button.callback(l[e].name+" 🔴","stopCat:"+r+":"+e)]):o.push([s.Markup.button.callback(l[e].name+" 🟢","stopCat:"+r+":"+e)]))}e.session.order?o.push([c.keyboard.order(e),c.keyboard.backT]):o.push([c.keyboard.backT]),yield e.editMessageText(e.i18n.t("menuPanel-dishes",{categoryName:i.name,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(o))),e.answerCbQuery()}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),y.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.AdminPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const f=new s.Composer;f.action(/^unStopRest\:/,(e=>r(void 0,void 0,void 0,(function*(){var t;try{const[,n]=e.callbackQuery.data.split(":");yield e.dbRestaurants.updateOne({_id:Number(n)},{$set:{isStop:""}}),yield e.answerCbQuery(e.i18n.t("success"),{show_alert:!0}),e.googleStopList.addRow({date:(new Date).toLocaleString("ru"),restaurant:n,action:"Ресторан ДОСТУПЕН для приёма заказов",user:null!==(t=e.from.username)&&void 0!==t?t:e.from.first_name});const r=(yield e.dbRestaurants.find({_id:Number(n)}).toArray())[0];return yield e.telegram.sendMessage(r.chat_id,`Ресторан <b>включен</b>\nВключил <a href="tg://user?id=${e.from.id}">${e.from.first_name}</a>`,{parse_mode:"HTML"}),yield e.panel.AdminPanel(e)}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}})))),f.action(/^stopRest\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t]=e.callbackQuery.data.split(":");return e.wizard.state.data={rest:Number(t)},yield e.answerCbQuery(e.i18n.t("adminPanel-stopRest-enterComment"),{show_alert:!0}),yield e.editMessageText(e.i18n.t("adminPanel-stopRest-enterComment"),{parse_mode:"HTML"}),yield e.wizard.selectStep(5)}catch(e){console.error(`${(new Date).toString()} cant >> ${__filename} error:`,e)}})))),f.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.AdminPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const _=new s.Composer;_.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.AdminPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),_.on("text",(e=>r(void 0,void 0,void 0,(function*(){var t;try{yield e.dbRestaurants.updateOne({_id:Number(e.wizard.state.data.rest)},{$set:{isStop:e.message.text.trim()}}),e.googleStopList.addRow({date:(new Date).toLocaleString("ru"),restaurant:e.wizard.state.data.rest,action:`Ресторан ОТКЛЮЧЕН для приёма заказов с комментарием: "${e.message.text.trim()}"`,user:null!==(t=e.from.username)&&void 0!==t?t:e.from.first_name});const n=(yield e.dbRestaurants.find({_id:e.wizard.state.data.rest}).toArray())[0];yield e.telegram.sendMessage(n.chat_id,`Ресторан <b>отключен</b>\n\nОтключил <a href="tg://user?id=${e.from.id}">${e.from.first_name}</a>\n\nКомментарий: <i>${e.message.text.trim()}</i>`,{parse_mode:"HTML"}),e.wizard.state.data={},yield e.deleteMessage(),yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("adminPanel-stopList-success",{message:e.message.text.trim()}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard([c.keyboard.backT])))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new s.Scenes.WizardScene("admin",l,p,m,y,f,_)},351:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(2167)),i=a(n(8941)),s=n(832),d=n(7745),c=n(5303),u=n(6968),l=n(8370),p=new s.Composer;p.action("yes",(e=>r(void 0,void 0,void 0,(function*(){try{if(e.session.phone)return e.editMessageText(e.i18n.t("checkout-goto",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard([[c.keyboard.checkout.here],[c.keyboard.checkout.take]]))),e.answerCbQuery(),yield e.wizard.selectStep(2);try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}return e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("checkout-getContact",{hat:e.i18n.t("hat")}),Object.assign({},s.Markup.keyboard([[s.Markup.button.contactRequest("Поделится контактом 📲")]]).oneTime().resize()))).message_id,e.answerCbQuery(),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),p.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const m=new s.Composer;m.on("contact",(e=>r(void 0,void 0,void 0,(function*(){var t;try{try{if(!e.session.id_mes_panel)return;try{yield e.telegram.deleteMessage(e.message.chat.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}try{yield e.telegram.deleteMessage(e.message.chat.id,e.message.message_id)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}if(e.message.contact.user_id!==(null===(t=e.from)||void 0===t?void 0:t.id))return void(e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("checkout-getContact-err-isNotThisUser",{hat:e.i18n.t("hat")}),Object.assign({},s.Markup.keyboard([[s.Markup.button.contactRequest("Поделится контактом 📲")]]).oneTime().resize()))).message_id);{let t=e.message.contact.phone_number;return"+"===t[0]&&(t=t.slice(1,12)),"8"===t[0]&&(t="7"+t.slice(1,11)),e.session.phone=t,e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("checkout-goto",{hat:e.i18n.t("hat")}),Object.assign({},s.Markup.inlineKeyboard([[c.keyboard.checkout.here],[c.keyboard.checkout.take]])))).message_id,yield e.wizard.next()}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),m.on("message",(e=>r(void 0,void 0,void 0,(function*(){try{try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("checkout-getContact",{hat:e.i18n.t("hat")}),Object.assign({},s.Markup.keyboard([[s.Markup.button.contactRequest("Поделится контактом 📲")]]).oneTime().resize()))).message_id}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const y=new s.Composer;y.action(/.+/,(e=>r(void 0,void 0,void 0,(function*(){try{e.wizard.state.data={},e.wizard.state.data.take="here"!==e.callbackQuery.data,e.editMessageText(e.i18n.t("checkout-time",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard([[c.keyboard.checkout.soon],[c.keyboard.checkout.inTime]]))),e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const f=new s.Composer;f.action("inTime",(e=>r(void 0,void 0,void 0,(function*(){try{const t=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],n=new Date((new Date).getTime()+24e5),r={amountH:n.getHours()===Number(t.workingHours.end)?n.getHours()-1:n.getHours(),amountM:n.getHours()===Number(t.workingHours.end)||10*Math.ceil(n.getMinutes())>59?50:10*Math.ceil(n.getMinutes()),workTime:t.workingHours};e.editMessageText(e.i18n.t("checkout-inTime",{hat:e.i18n.t("hat"),props:r}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(c.keyboard.checkout.timeCounter(r)))),e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),f.action("soon",(e=>r(void 0,void 0,void 0,(function*(){try{(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],e.wizard.state.data.time="Как можно скорее",e.editMessageText(e.i18n.t("checkout-comment",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard([[c.keyboard.checkout.noComment]]))),e.wizard.selectStep(5)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),f.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const _=new s.Composer;_.action(/^time\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n]=e.callbackQuery.data.split(":"),r=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],a={amountH:Number(n)>=60?Number(t)+1:Number(n)<0?Number(t)-1:Number(t),amountM:Number(n)>=60?0:Number(n)<0?50:Number(t)===(new Date).getHours()?Number(n)+40>(new Date).getMinutes()?Number(n):50:Number(n),workTime:r.workingHours};yield e.editMessageText(e.i18n.t("checkout-inTime",{hat:e.i18n.t("hat"),props:a}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(c.keyboard.checkout.timeCounter(a)))),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),_.action(/^yes\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n]=e.callbackQuery.data.split(":");e.wizard.state.data.time=(1===t.toString().length?"0"+t.toString():t)+":"+(1===n.toString().length?"0"+n.toString():n),yield e.editMessageText(e.i18n.t("checkout-comment",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard([[c.keyboard.checkout.noComment]]))),e.answerCbQuery(),e.wizard.selectStep(5)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),_.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const h=new s.Composer;h.on("text",(e=>r(void 0,void 0,void 0,(function*(){try{e.wizard.state.data.comment=e.message.text;try{yield e.telegram.deleteMessage(e.from.id,e.message.message_id)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}let t=0;const n=new i.default;n.append("secret",(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].frontPad),n.append("client_phone","8"+e.session.phone.toString().slice(1,11)),yield(0,o.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?get_client",data:n}).then((e=>r(void 0,void 0,void 0,(function*(){"success"===e.data.result&&(t=Number(e.data.score))}))));const a=[[c.keyboard.checkout.payInRestaurant]];return t>=(0,u.productsSum)(e.session.order)&&(e.session.last_bonus_write_off?e.session.last_bonus_write_off+432e5<(new Date).getTime()&&a.push([c.keyboard.checkout.payBonus(Math.floor(t),(0,u.productsSum)(e.session.order))]):a.push([c.keyboard.checkout.payBonus(Math.floor(t),(0,u.productsSum)(e.session.order))])),a.push([c.keyboard.checkout.return]),yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("checkout-pay",{hat:e.i18n.t("hat"),sum:(0,u.productsSum)(e.session.order),time:e.wizard.state.data.time}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(a))),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),h.action("noComment",(e=>r(void 0,void 0,void 0,(function*(){try{let t=0;const n=new i.default;n.append("secret",(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].frontPad),n.append("client_phone","8"+e.session.phone.toString().slice(1,11)),yield(0,o.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?get_client",data:n}).then((e=>r(void 0,void 0,void 0,(function*(){"success"===e.data.result&&(t=Number(e.data.score))}))));const a=[[c.keyboard.checkout.payInRestaurant]];return t>=(0,u.productsSum)(e.session.order)&&(e.session.last_bonus_write_off?e.session.last_bonus_write_off+432e5<(new Date).getTime()&&a.push([c.keyboard.checkout.payBonus(Math.floor(t),(0,u.productsSum)(e.session.order))]):a.push([c.keyboard.checkout.payBonus(Math.floor(t),(0,u.productsSum)(e.session.order))])),a.push([c.keyboard.checkout.return]),yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("checkout-pay",{hat:e.i18n.t("hat"),sum:(0,u.productsSum)(e.session.order),time:e.wizard.state.data.time}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(a))),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),h.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const b=new s.Composer;b.action("payInRestaurant",(e=>r(void 0,void 0,void 0,(function*(){try{const t=JSON.parse(JSON.stringify(e.session.order));if(e.session.order=yield(0,l.updatePrices)(e.session.order,e.session.restaurant_id),(0,u.productsSum)(t)!==(0,u.productsSum)(e.session.order))return yield e.answerCbQuery("Внимание✋\n Цены, продукты или добавки в корзине изменились\n\nНажмите ещё раз и проверьте изменения перед заказом",{show_alert:!0}),e.session.order.length<1?(delete e.session.order,yield e.panel.MainPanel(e)):yield e.panel.OrderPanel(e);const n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],r=(new Date).getHours();return r<n.workingHours.start||r>=n.workingHours.end?(yield e.answerCbQuery(e.i18n.t("restaurant-isClose"),{show_alert:!0}),yield e.panel.OrderPanel(e)):n.isStop.length>0?(yield e.answerCbQuery(e.i18n.t("restaurant-isStop",{message:n.isStop}),{show_alert:!0}),yield e.panel.OrderPanel(e)):yield(0,d.createOrder)(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),b.action("payOnline",(e=>r(void 0,void 0,void 0,(function*(){try{const t=JSON.parse(JSON.stringify(e.session.order));if(e.session.order=yield(0,l.updatePrices)(e.session.order,e.session.restaurant_id),(0,u.productsSum)(t)!==(0,u.productsSum)(e.session.order))return yield e.answerCbQuery("Внимание✋\n Цены, продукты или добавки в корзине изменились\n\nНажмите ещё раз и проверьте изменения перед заказом",{show_alert:!0}),e.session.order.length<1?(delete e.session.order,yield e.panel.MainPanel(e)):yield e.panel.OrderPanel(e);const n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],r=(new Date).getHours();return r<n.workingHours.start||r>=n.workingHours.end?(yield e.answerCbQuery(e.i18n.t("restaurant-isClose"),{show_alert:!0}),yield e.panel.OrderPanel(e)):n.isStop.length>0?(yield e.answerCbQuery(e.i18n.t("restaurant-isStop",{message:n.isStop}),{show_alert:!0}),yield e.panel.OrderPanel(e)):yield(0,d.createOrder)(e,!0)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),b.action(/^bonusPay\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const t=JSON.parse(JSON.stringify(e.session.order));if(e.session.order=yield(0,l.updatePrices)(e.session.order,e.session.restaurant_id),(0,u.productsSum)(t)!==(0,u.productsSum)(e.session.order))return yield e.answerCbQuery("Внимание✋\n Цены, продукты или добавки в корзине изменились\n\nНажмите ещё раз и проверьте изменения перед заказом",{show_alert:!0}),e.session.order.length<1?(delete e.session.order,yield e.panel.MainPanel(e)):yield e.panel.OrderPanel(e);const[,n]=e.callbackQuery.data.split(":"),r=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],a=(new Date).getHours();return e.wizard.state.data.bonus=Number(n),a<r.workingHours.start||a>=r.workingHours.end?(yield e.answerCbQuery(e.i18n.t("restaurant-isClose"),{show_alert:!0}),yield e.panel.OrderPanel(e)):r.isStop.length>0?(yield e.answerCbQuery(e.i18n.t("restaurant-isStop",{message:r.isStop}),{show_alert:!0}),yield e.panel.OrderPanel(e)):yield(0,d.createOrder)(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),b.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new s.Scenes.WizardScene("checkout",p,m,y,f,_,h,b)},3818:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(8542),i=n(5303),s=n(5703),d=n(5088),c=n(9184),u=new a.Composer;u.action(/^category\:/,(e=>r(void 0,void 0,void 0,(function*(){try{if(e.callbackQuery&&e.callbackQuery.data){const t=(yield e.config.find({name:"categories"}).toArray())[0].data.find((t=>t.id===Number(e.callbackQuery.data.split(":")[1])));if(t.children){const n=(yield e.config.find({name:"categories"}).toArray())[0].data.filter((e=>t.children.includes(e.id))),r=(0,o.CreateMultilineKeyboard)(n,"category","id",1,"name"),s=[];return r.map((e=>{s.push(e)})),e.session.order?s.push([i.keyboard.order(e),i.keyboard.backB]):s.push([i.keyboard.backB]),yield e.editMessageText(e.i18n.t("menuPanel",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(s))),e.answerCbQuery()}{const n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].products.filter((e=>{for(let n of t.indexes)if(-1!==e.name.toLowerCase().indexOf(n.toLowerCase())&&!e.stop)return!0})).map((e=>[a.Markup.button.callback(e.name+" | "+e.price+" руб","add:1:"+e.product_id)]));return e.session.order?n.push([i.keyboard.order(e),i.keyboard.backT]):n.push([i.keyboard.backT]),yield e.editMessageText(e.i18n.t("menuPanel-dishes",{categoryName:t.name,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(n))),e.answerCbQuery(),yield e.wizard.next()}}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.action("back",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MainPanel(e,!0),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.action("backB",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MenuPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.action("order",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const l=new a.Composer;l.action(/^add\:/,(e=>r(void 0,void 0,void 0,(function*(){try{return yield(0,d.ProductCard)(e),e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),l.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MenuPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),l.action("order",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const p=new a.Composer;p.action(/^add\:/,(e=>r(void 0,void 0,void 0,(function*(){try{yield(0,d.ProductCard)(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),p.action("plusOrder",(e=>r(void 0,void 0,void 0,(function*(){try{if(!e.callbackQuery||!e.callbackQuery.data)return e.answerCbQuery();const t=e.wizard.state.data.viewProduct;return t.additivesProducts&&delete t.additivesProducts,t.description&&delete t.description,t.exceptionsProducts&&delete t.exceptionsProducts,e.session.order?(0,c.productsToString)(e.session.order).length<2e3?(e.session.order.push(t),e.answerCbQuery(e.i18n.t("menuPanel-added-success"),{show_alert:!0})):e.answerCbQuery(e.i18n.t("menuPanel-added-error-many"),{show_alert:!0}):e.session.order=[t],void(yield e.panel.MenuPanel(e))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),p.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MenuPanel(e),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),p.action("dop:start",(e=>r(void 0,void 0,void 0,(function*(){try{return yield(0,s.AdditivesCard)(e),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),p.action("exceptions:start",(e=>r(void 0,void 0,void 0,(function*(){try{return yield(0,s.AdditivesCard)(e,!0),yield e.wizard.selectStep(4)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const m=new a.Composer;m.action(/^dop\:/,(e=>r(void 0,void 0,void 0,(function*(){try{yield(0,s.AdditivesCard)(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),m.action("save",(e=>r(void 0,void 0,void 0,(function*(){try{return yield(0,d.ProductCard)(e),e.wizard.selectStep(2),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const y=new a.Composer;y.action(/^dop\:/,(e=>r(void 0,void 0,void 0,(function*(){try{yield(0,s.AdditivesCard)(e,!0)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),y.action("save",(e=>r(void 0,void 0,void 0,(function*(){try{return yield(0,d.ProductCard)(e),e.wizard.selectStep(2),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new a.Scenes.WizardScene("menu",u,l,p,m,y)},5609:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(5303),i=n(6968),s=n(8370),d=new a.Composer;d.action("edit",(e=>r(void 0,void 0,void 0,(function*(){try{if(e.callbackQuery&&e.callbackQuery.data){const t=e.session.order,n=[[o.keyboard.orderPanel.clear,o.keyboard.backT]];for(let e=0;e<t.length;){const r=[];for(let n=0;n<2;++n)e<t.length&&(r.push(a.Markup.button.callback(t[e].name,"editProd:"+t[e].amount+":"+e)),++e);n.push(r)}return yield e.editMessageText(e.i18n.t("orderPanel-editOrder",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(n))),yield e.answerCbQuery(),e.wizard.next()}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),d.action("back",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.panel.MainPanel(e,!0),yield e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),d.action("promo",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.editMessageText(e.i18n.t("orderPanel-sendPromo",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT]))),yield e.wizard.selectStep(3),yield e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),d.action("checkout",(e=>r(void 0,void 0,void 0,(function*(){try{const t=JSON.parse(JSON.stringify(e.session.order));if(e.session.order=yield(0,s.updatePrices)(e.session.order,e.session.restaurant_id),(0,i.productsSum)(t)!==(0,i.productsSum)(e.session.order))return yield e.answerCbQuery("Внимание✋\n Цены, продукты или добавки в корзине изменились\n\nНажмите ещё раз и проверьте изменения перед заказом",{show_alert:!0}),e.session.order.length<1?(delete e.session.order,yield e.panel.MainPanel(e)):yield e.panel.OrderPanel(e);const n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],r=(new Date).getHours();if(r<n.workingHours.start||r>=n.workingHours.end)return yield e.answerCbQuery(e.i18n.t("restaurant-isClose"),{show_alert:!0});if(n.isStop.length>0)return yield e.answerCbQuery(e.i18n.t("restaurant-isStop",{message:n.isStop}),{show_alert:!0});if(yield e.scene.leave(),yield e.scene.enter("checkout"),e.session.phone)return e.editMessageText(e.i18n.t("checkout-goto",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([[o.keyboard.checkout.here],[o.keyboard.checkout.take]]))),e.answerCbQuery(),yield e.wizard.selectStep(2);try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}return e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("checkout-getContact",{hat:e.i18n.t("hat")}),Object.assign({},a.Markup.keyboard([[a.Markup.button.contactRequest("Поделится контактом 📲")]]).oneTime().resize()))).message_id,e.answerCbQuery(),yield e.wizard.next()}catch(e){console.error("cant panel scene",e)}}))));const c=new a.Composer;c.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action("clear",(e=>r(void 0,void 0,void 0,(function*(){try{return delete e.session.order,e.session.promo_order&&delete e.session.promo_order,yield e.panel.OrderPanel(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action(/^editProd\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n]=e.callbackQuery.data.split(":"),r=Number(n);e.session.order[r].amount=Number(t);const i=e.session.order[r];if(e.session.order[r].promo)return void(yield e.answerCbQuery(e.i18n.t("orderPanel-promo-notEdited"),{show_alert:!0}));const s=[o.keyboard.counter(Number(t),"editProd",n,"sht"),[o.keyboard.orderPanel.save,o.keyboard.orderPanel.delete(r)]];return yield e.editMessageText(e.i18n.t("orderPanel-editProd",{product:i,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(s))),yield e.answerCbQuery(),e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const u=new a.Composer;u.action(/^editProd\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t,n]=e.callbackQuery.data.split(":"),r=Number(n);if(e.session.order[r].promo)return void(yield e.answerCbQuery(e.i18n.t("orderPanel-promo-notEdited"),{show_alert:!0}));{e.session.order[r].amount=Number(t);const i=e.session.order[r],s=[o.keyboard.counter(Number(t),"editProd",n,"sht"),[o.keyboard.orderPanel.save,o.keyboard.orderPanel.delete(r)]];yield e.editMessageText(e.i18n.t("orderPanel-editProd",{product:i,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(s))),yield e.answerCbQuery()}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.action(/^del\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t]=e.callbackQuery.data.split(":");return e.session.order.splice(Number(t),1),e.session.order.length?(yield e.panel.OrderPanel(e),yield e.answerCbQuery()):(delete e.session.order,yield e.panel.MainPanel(e),yield e.answerCbQuery())}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.action("save",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.OrderPanel(e)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const l=new a.Composer;l.action("backT",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.MainPanel(e,!0)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),l.on("text",(e=>r(void 0,void 0,void 0,(function*(){try{try{e.deleteMessage()}catch(e){}if(e.session.promo_order)return void(yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-orderIsUsed",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT]))));const t=(yield e.config.find({name:"promo"}).toArray())[0].data.find((t=>t.name===e.message.text.toLowerCase()));if(e.session.used_promo&&e.session.used_promo.find((t=>t===e.message.text.toLowerCase()))&&4!==t.use)return void(yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-isUsed",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT]))));if(t){if((e.session.order?(0,i.productsSum)(e.session.order):0)<t.condition)return yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-condition",{hat:e.i18n.t("hat"),sum:t.condition}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])));if(!t.active)return yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-notFined",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])));if(1===t.use){if(e.session.used_promo)return yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-isFirst",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])))}else if(2===t.use){if(e.session.orders)return yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-isFirst",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])))}else if(3===t.use&&!t.users.includes(e.from.id))return yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-notFourYou",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])));if("dish"===t.type){const n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].products.find((e=>e.product_id===t.value)),r={product_id:n.product_id,amount:1,name:n.name,price:n.price,promo:!0,stop:!1,additives:[]};e.session.order?e.session.order.push(r):e.session.order=[r],e.session.promo_order=e.message.text.toLowerCase(),yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-success",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])))}else if("dishes"===t.type){const n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].products.filter((e=>{for(let n of t.value)if(-1!==e.product_id.indexOf(n))return!0})).map((e=>[a.Markup.button.callback("🎁 "+e.name,"add:"+e.product_id)]));return e.session.promo_order=e.message.text.toLowerCase(),yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-options",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(n))),e.wizard.next()}}else yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"1",e.i18n.t("orderPanel-sendPromo-notFined",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([o.keyboard.backT])))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const p=new a.Composer;p.action(/^add\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const[,t]=e.callbackQuery.data.split(":"),n=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].products.find((e=>e.product_id===t)),r={product_id:n.product_id,amount:1,name:n.name,price:n.price,promo:!0,stop:!1,additives:[]};e.session.order?e.session.order.push(r):e.session.order=[r],yield e.answerCbQuery(e.i18n.t("orderPanel-promo-success-add"),{show_alert:!0}),yield e.panel.MainPanel(e,!0)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new a.Scenes.WizardScene("order",d,c,u,l,p)},7264:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(2167)),i=a(n(8941)),s=n(832),d=n(5303),c=new s.Composer;c.action("changeRestaurant",(e=>r(void 0,void 0,void 0,(function*(){try{const t=[[d.keyboard.back]];return(yield e.dbRestaurants.find().toArray()).map((e=>{t.push([s.Markup.button.callback(e.address,"go:"+e._id)])})),yield e.editMessageText(e.i18n.t("mainPanel-changeRestaurant",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard(t))),e.answerCbQuery(),yield e.wizard.selectStep(1)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action("addBonus",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.AddBonusAccountPanel(e),e.answerCbQuery(),yield e.scene.leave(),yield e.scene.enter("register"),yield e.wizard.selectStep(1)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action("bonus",(e=>r(void 0,void 0,void 0,(function*(){try{const t=new i.default;t.append("secret",(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].frontPad),t.append("client_phone","8"+e.session.phone.toString().slice(1,11)),(0,o.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?get_client",data:t}).then((t=>r(void 0,void 0,void 0,(function*(){return"success"===t.data.result?yield e.answerCbQuery(`У Вас ${t.data.score} бонусов на счету!`,{show_alert:!0}):"invalid_client_phone"===t.data.error?yield e.answerCbQuery("❌ Номер не найден в бонусной системе\n\nЕсли Вы были зарегистрированы в нашей бонусной системе, то уточните информацию у персонала ресторана.",{show_alert:!0}):yield e.answerCbQuery("❌ Произошла ошибка. Попробуйте позже",{show_alert:!0})}))))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action("menu",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.panel.MenuPanel(e),e.answerCbQuery()}catch(e){console.error("cant panel scene",e)}})))),c.action("order",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.panel.OrderPanel(e),e.answerCbQuery()}catch(e){console.error("cant panel scene",e)}})))),c.action("adminPanelA",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.AdminPanel(e)}catch(e){console.error("cant panel scene",e)}})))),c.action("promoMain",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.scene.leave(),yield e.scene.enter("order"),yield e.wizard.selectStep(3),yield e.editMessageText(e.i18n.t("orderPanel-sendPromo",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},s.Markup.inlineKeyboard([d.keyboard.backT]))),yield e.answerCbQuery()}catch(e){console.error("cant panel scene",e)}}))));const u=new s.Composer;u.action(/^go\:/,(e=>r(void 0,void 0,void 0,(function*(){try{if(!e.callbackQuery||!e.callbackQuery.data)return;e.session.restaurant_id=Number(e.callbackQuery.data.split(":")[1]),e.session.order&&delete e.session.order,yield e.panel.MainPanel(e,!0),e.answerCbQuery(e.i18n.t("success"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.action("back",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.panel.MainPanel(e,!0),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new s.Scenes.WizardScene("panel",c,u)},4916:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(8013),o=n(832),i=n(5303),s=n(137),d=(e,t)=>r(void 0,void 0,void 0,(function*(){try{let n=!1,d="";e.wizard.state.data._id.includes("-")?d=e.wizard.state.data._id:(d=new a.ObjectId(e.wizard.state.data._id),n=!0);const c=(yield e.dbOrders.find({_id:d}).toArray())[0],u=(yield e.dbRestaurants.find({_id:c.restaurant_id}).toArray())[0],l=e=>e.caus?"string"==typeof e.caus?e.caus:e.caus.map((e=>s.rateCauses[Number(e)].text)).join(" | "):"";if(t)try{yield e.deleteMessage()}catch(e){}try{yield e.deleteMessage(e.session.mid)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.mid,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}if(t){if(e.message.photo){if(!e.message.caption)return e.session.mid=(yield e.replyWithHTML(e.i18n.t("rate-photo-addComment"),Object.assign({},o.Markup.inlineKeyboard([i.keyboard.rate.no_comment])))).message_id,c.rate={caus:l(e.wizard.state.data),comment:"",grade:e.wizard.state.data.grade,photo:e.message.photo[e.message.photo.length-1].file_id},void(yield e.dbOrders.updateOne({_id:c._id},{$set:c}));c.rate?(c.rate.comment=e.message.caption,c.rate.photo=e.message.photo[e.message.photo.length-1].file_id):c.rate={caus:l(e.wizard.state.data),comment:e.message.caption,grade:e.wizard.state.data.grade,photo:e.message.photo[e.message.photo.length-1].file_id}}else if(e.message.text){let t=e.message.text;"/menu"===e.message.text&&(t=""),c.rate?c.rate.comment=t:c.rate={caus:l(e.wizard.state.data),comment:t,grade:e.wizard.state.data.grade}}}else c.rate||(c.rate={caus:l(e.wizard.state.data),comment:"",grade:e.wizard.state.data.grade});(c.rate.grade<4||c.rate.comment||c.rate.photo)&&(c.rate.photo?yield e.telegram.sendPhoto(u.rate_chat_id,c.rate.photo,{caption:e.i18n.t("rate-toChat",{order:c,restaurant:u}),parse_mode:"HTML"}).then((t=>r(void 0,void 0,void 0,(function*(){if(c.rate.grade<4)try{yield e.telegram.pinChatMessage(t.chat.id,t.message_id)}catch(e){console.error("pinErr",e)}})))):yield e.telegram.sendMessage(u.rate_chat_id,e.i18n.t("rate-toChat",{order:c,restaurant:u}),{parse_mode:"HTML"}).then((t=>r(void 0,void 0,void 0,(function*(){if(c.rate.grade<4)try{yield e.telegram.pinChatMessage(t.chat.id,t.message_id)}catch(e){console.error("pinErr",e)}}))))),yield e.replyWithHTML(e.i18n.t("rate-thankYou")),yield e.scene.leave(),yield e.google.addRow({date:c.date+" "+c.time,order:n?c._id.toString():c._id,grade:c.rate.grade,br:l(e.wizard.state.data),comment:c.rate.comment?c.rate.comment:"",photo:c.rate.photo?(yield e.telegram.getFileLink(c.rate.photo)).toString():"",client:c.client.number,restaurant:u.address,fp_number:c.fp_number?c.fp_number:""}),yield e.dbOrders.updateOne({_id:c._id},{$set:c}),delete e.session.mid}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})),c=new o.Composer;c.action(/^rCaus\:/,(e=>r(void 0,void 0,void 0,(function*(){try{const{grade:t,caus:n,_id:r}=e.wizard.state.data,a=e.callbackQuery.data.split(":")[1];if(e.wizard.state.data.caus.includes(a)){const t=e.wizard.state.data.caus.findIndex((e=>a===e));e.wizard.state.data.caus.splice(t,1)}else e.wizard.state.data.caus.push(a);t<4?yield e.editMessageText(e.i18n.t("rate-noLike"),Object.assign({},o.Markup.inlineKeyboard(i.keyboard.rate.rate_br(n,t)))):4===t?yield e.editMessageText(e.i18n.t("rate-soSo"),Object.assign({},o.Markup.inlineKeyboard(i.keyboard.rate.rate_br(n,t)))):yield e.editMessageText(e.i18n.t("rate-like"),Object.assign({},o.Markup.inlineKeyboard(i.keyboard.rate.rate_br(n,t))))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action("save",(e=>r(void 0,void 0,void 0,(function*(){try{yield d(e,!1)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),c.action("comment",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.editMessageText(e.i18n.t("rate-comment"),Object.assign({},o.Markup.inlineKeyboard([i.keyboard.rate.no_comment]))),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const u=new o.Composer;u.action("noComment",(e=>r(void 0,void 0,void 0,(function*(){try{yield d(e,!1)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),u.on("message",(e=>r(void 0,void 0,void 0,(function*(){try{yield d(e,!0)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new o.Scenes.WizardScene("rateOrder",c,u)},989:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(5303),i=new a.Composer;i.action("yes",(e=>r(void 0,void 0,void 0,(function*(){try{return yield e.panel.AddBonusAccountPanel(e),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const s=new a.Composer;s.on("contact",(e=>r(void 0,void 0,void 0,(function*(){var t;try{try{if(!e.session.id_mes_panel)return;yield e.telegram.deleteMessage(e.message.chat.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}try{yield e.telegram.deleteMessage(e.message.chat.id,e.message.message_id)}catch(e){}if(e.message.contact.user_id!==(null===(t=e.from)||void 0===t?void 0:t.id))return void(e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("enterPhoneNumber-err-isNotThisUser",{hat:e.i18n.t("hat")}),Object.assign({},a.Markup.keyboard([[a.Markup.button.contactRequest("Поделится контактом 📲")]]).oneTime().resize()))).message_id);{let t=e.message.contact.phone_number;return"+"===t[0]&&(t=t.slice(1,12)),"8"===t[0]&&(t="7"+t.slice(1,11)),e.session.phone=t,e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("enterPhoneNumber-yes",{hat:e.i18n.t("hat")}),Object.assign({},a.Markup.inlineKeyboard(o.keyboard.RegisterPanel)))).message_id,yield e.wizard.next()}}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const d=new a.Composer;d.action("yes",(e=>r(void 0,void 0,void 0,(function*(){try{const t=[];return(yield e.dbRestaurants.find().toArray()).map((e=>{t.push([a.Markup.button.callback(e.address,"go:"+e._id)])})),yield e.editMessageText(e.i18n.t("RegisterPanel-choiceRestaurant",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(t))),yield e.scene.leave(),yield e.scene.enter("panel"),yield e.wizard.selectStep(1)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new a.Scenes.WizardScene("register",i,s,d)},8542:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CreateMultilineKeyboard=void 0;const r=n(832);t.CreateMultilineKeyboard=(e,t,n,a,o)=>{const i=[];for(let s=0;s<e.length;){const d=[];for(let i=0;i<a;++i)s<e.length&&(d.push(r.Markup.button.callback(e[s][o],t+":"+e[s][n])),++s);i.push(d)}return i}},698:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.changeStatus=void 0;const a=n(832),o=n(7665),i=n(5303),s=n(5708),d=n(9184),c=n(5692);t.changeStatus=e=>r(void 0,void 0,void 0,(function*(){var t,n,u;try{const{orderNumber:l,status:p}=e,m=l,y=(yield o.bot.context.dbOrders.find({_id:m}).toArray())[0],f=(yield o.bot.context.dbRestaurants.find({_id:y.restaurant_id}).toArray())[0],_=(0,d.productsToString)(y.products);let h="";switch(p){case 0:h="ожидает оплаты";break;case 1:h="оформлен (ожидание)";break;case 2:h="оформлен";break;case 3:h="готовится";break;case 4:h="готов к выдаче";break;case 5:h="получен";break;case 6:h="отменён";break;case 7:h="отменён (до оплаты)"}if(y.status===h&&"оформлен"!==h)return;y.status=h;const b=[];if(3===p)y.changeStatusTime={toCooking:(new Date).toLocaleTimeString("ru")},y.fp_id?b.push([i.keyboard.changeStatus.cancel(y._id)]):b.push([i.keyboard.changeStatus.ready(y._id),i.keyboard.changeStatus.cancel(y._id)]);else if(4===p)(null===(t=y.changeStatusTime)||void 0===t?void 0:t.toCooking)||(y.changeStatusTime=Object.assign(Object.assign({},y.changeStatusTime),{toCooking:(new Date).toLocaleTimeString("ru")})),y.changeStatusTime=Object.assign(Object.assign({},y.changeStatusTime),{toReady:(new Date).toLocaleTimeString("ru")}),y.fp_id?b.push([i.keyboard.changeStatus.cancel(y._id)]):b.push([i.keyboard.changeStatus.placed(y._id),i.keyboard.changeStatus.cancel(y._id)]);else if(2===p)y.fp_id?(y.changeStatusTime={},b.push([i.keyboard.changeStatus.cancel(y._id)])):b.push([i.keyboard.changeStatus.accept(y._id),i.keyboard.changeStatus.cancel(y._id)]);else if(5===p){if((null===(n=y.changeStatusTime)||void 0===n?void 0:n.toCooking)||(y.changeStatusTime=Object.assign(Object.assign({},y.changeStatusTime),{toCooking:(new Date).toLocaleTimeString("ru")})),(null===(u=y.changeStatusTime)||void 0===u?void 0:u.toReady)||(y.changeStatusTime=Object.assign(Object.assign({},y.changeStatusTime),{toReady:(new Date).toLocaleTimeString("ru")})),y.changeStatusTime=Object.assign(Object.assign({},y.changeStatusTime),{received:(new Date).toLocaleTimeString("ru")}),!y.fp_id)try{o.bot.telegram.unpinChatMessage(f.chat_id,y.client.restaurant_message_id)}catch(e){console.log(e)}}else if(6===p&&!y.fp_id)try{o.bot.telegram.unpinChatMessage(f.chat_id,y.client.restaurant_message_id)}catch(e){console.log(e)}try{yield o.bot.telegram.deleteMessage(y.client.chatId,y.client.message_id)}catch(e){try{yield o.bot.telegram.editMessageText(y.client.chatId,y.client.message_id,"0",".")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}yield o.bot.telegram.editMessageText(f.chat_id,y.client.restaurant_message_id,"0",s.messages.changeStatusNew(y,f,_),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(b))),yield o.bot.telegram.sendMessage(y.client.chatId,s.messages.changeStatusClient(y,f,_),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard("получен"===y.status?[[i.keyboard.changeStatus.newOrder],[i.keyboard.changeStatus.repeat(y._id)]]:[]))).then((e=>r(void 0,void 0,void 0,(function*(){y.client.message_id=e.message_id,"получен"===y.status&&(yield(0,c.rateOrder)(y))})))),yield o.bot.context.dbOrders.updateOne({_id:y._id},{$set:y})}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},7745:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createOrder=void 0;const o=n(832),i=n(1114),s=n(5303),d=n(6968),c=n(2387),u=n(9854),l=a(n(8941)),p=a(n(2167));t.createOrder=(e,t)=>r(void 0,void 0,void 0,(function*(){var n;try{const a=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0],m=(new Date).getHours();if(m<a.workingHours.start||m>=a.workingHours.end)return yield e.answerCbQuery(e.i18n.t("restaurant-isClose"),{show_alert:!0}),yield e.panel.OrderPanel(e);if(a.isStop.length>0)return yield e.answerCbQuery(e.i18n.t("restaurant-isStop",{message:a.isStop}),{show_alert:!0}),yield e.panel.OrderPanel(e);if(-1!==(yield e.config.find({name:"ban-list"}).toArray())[0].data.findIndex((t=>t.phone.toString()===e.session.phone.toString())))return yield e.answerCbQuery(e.i18n.t("isBanned"),{show_alert:!0}),yield e.panel.OrderPanel(e);let y="";try{const t=new l.default;t.append("secret",(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].frontPad),t.append("client_phone","8"+e.session.phone.toString().slice(1,11)),yield(0,p.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?get_client",data:t}).then((t=>r(void 0,void 0,void 0,(function*(){y="success"===t.data.result?"":(t.data.error,e.from.first_name)}))))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}const f={_id:yield(0,u.generateOrderId)(e),sum:(0,d.productsSum)(e.session.order),bonusSum:e.wizard.state.data.bonus?e.wizard.state.data.bonus:0,status:"ожидает оплаты",payType:t?"онлайн оплата":"оплата при получении",restaurant_id:e.session.restaurant_id,date:(new Date).toLocaleDateString("ru"),time:(new Date).toLocaleTimeString("ru"),take:e.wizard.state.data.take,cookingTime:e.wizard.state.data.time,comment:e.wizard.state.data.comment?e.wizard.state.data.comment:"",client:{username:e.from.username,number:null!==(n=e.session.phone)&&void 0!==n?n:"0",first_name:y,chatId:e.from.id},products:e.session.order.map((e=>e))};if(f.bonusSum&&(e.session.last_bonus_write_off=(new Date).getTime()),yield e.dbOrders.insertOne(f),e.session.orders?e.session.orders.push(f._id):e.session.orders=[f._id],e.session.promo_order){const t=(yield e.config.find({name:"promo"}).toArray())[0],n=t.data.find((t=>t.name===e.session.promo_order)),r=t.data.findIndex((t=>t.name===e.session.promo_order));yield e.config.updateOne({name:"promo"},{$set:{["data."+r+".counter"]:n.counter+1}}),e.session.used_promo?e.session.used_promo.push(e.session.promo_order):e.session.used_promo=[e.session.promo_order],delete e.session.promo_order}delete e.session.id_mes_panel,delete e.session.order;try{yield e.deleteMessage()}catch(t){try{yield e.telegram.editMessageText(e.callbackQuery.message.chat.id,e.callbackQuery.message.message_id,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}console.error(`Cant del err >> ${__filename} error:`,t)}if(yield e.scene.leave(),t){const t=new Date((new Date).getTime()+12e5);return yield e.replyWithInvoice((0,i.getInvoice)(f),o.Markup.inlineKeyboard([[s.keyboard.checkout.payButton(`${t.toLocaleTimeString("ru")}`)]])).then((t=>r(void 0,void 0,void 0,(function*(){setTimeout((()=>r(void 0,void 0,void 0,(function*(){const n=f._id,r=(yield e.dbOrders.find({_id:n}).toArray())[0];"ожидает оплаты"===r.status&&(yield e.deleteMessage(t.message_id),r.status="отменён (до оплаты)",yield e.dbOrders.updateOne({_id:r._id},{$set:r}),yield e.replyWithHTML(e.i18n.t("order-canceled-time")))}))),12e5)}))))}return f.cookingTime,yield(0,c.sendOrder)(e,f)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},9854:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.generateOrderId=void 0,t.generateOrderId=e=>n(void 0,void 0,void 0,(function*(){try{let t="";for(;!t;){const n=(new Date).toLocaleDateString("ru",{day:"2-digit",month:"2-digit",year:"2-digit"}).split(".").join("")+"-"+Math.floor(1e5+9e5*Math.random());0===(yield e.dbOrders.find({_id:n}).toArray().length)||(t=n)}return t}catch(e){return console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e),(new Date).toLocaleDateString("ru",{day:"2-digit",month:"2-digit",year:"2-digit"}).split(".").join("")+"-"+Math.floor(1e5+9e5*Math.random())}}))},9042:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getAdminLvl=void 0;const a=n(7665);t.getAdminLvl=e=>r(void 0,void 0,void 0,(function*(){const t=(yield a.bot.context.config.find({name:"admins"}).toArray())[0].data.find((t=>t.chatId===e));return t?t.lvl:0}))},1114:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getInvoice=void 0,t.getInvoice=e=>{const t=e.products.reduce(((e,t)=>{const n=[...e];if(n.push({label:`${t.name} | ${t.amount} шт | ${t.price} руб/шт`,amount:t.price*t.amount*100}),t.additives){const e=t.additives.reduce(((e,n)=>e+n.price*t.amount),0);e&&n.push({label:"  └добавки",amount:100*e})}return n}),[]);return{chat_id:e.client.chatId,provider_token:process.env.PROVIDER_TOKEN,start_parameter:"cs",title:"Заказ #"+e._id,description:"Необходимо оплатить в течении 20 минут после получения данного сообщения об оплате",currency:"RUB",photo_url:"https://i.imgur.com/Fw0Zay8.jpg",prices:t,payload:JSON.stringify({_id:e._id})}}},1140:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getRestReport=void 0;const o=a(n(8311));t.getRestReport=(e,t)=>r(void 0,void 0,void 0,(function*(){try{o.default.schedule(`25 ${e.workingHours.end} * * *`,(()=>r(void 0,void 0,void 0,(function*(){const n=(yield t.context.dbOrders.find({$and:[{date:(new Date).toLocaleDateString("ru")},{restaurant_id:e._id},{status:"получен"}]}).toArray()).filter((e=>e.changeStatusTime));if(!n.length)return;const r=Math.floor(n.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.time.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.toCooking.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/n.length),a=Math.floor(r/60)+":"+(1===(r%60).toString().length?"0"+r%60:r%60),o=Math.floor(n.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.changeStatusTime.toCooking.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.toReady.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/n.length),i=Math.floor(o/60)+":"+(1===(o%60).toString().length?"0"+o%60:o%60),s=Math.floor(n.reduce(((e,t)=>{const[n,r,a]=t.date.split("."),[o,i,s]=t.changeStatusTime.toReady.split(":"),d=new Date(Number(a),Number(r)-1,Number(n),Number(o),Number(i),Number(s)),[c,u,l]=t.changeStatusTime.received.split(":"),p=new Date(Number(a),Number(r)-1,Number(n),Number(c),Number(u),Number(l));return e+Math.floor((p.getTime()-d.getTime())/1e3)}),0)/n.length),d=Math.floor(s/60)+":"+(1===(s%60).toString().length?"0"+s%60:s%60),c=`Сформирован отчёт по скорости за ${(new Date).toLocaleDateString("ru")}\n\nСреднее время принятия заказа: ${a}\nСреднее время приготовления заказа: ${i}\nОбщее среднее время от принятия до приготовления: <b>${Math.floor((r+o)/60)+":"+(1===((r+o)%60).toString().length?"0"+(r+o)%60:(r+o)%60)}</b>\n\nСреднее время выдачи заказа: ${d}`;yield t.telegram.sendMessage(e.rate_chat_id,c,{parse_mode:"HTML"})}))))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},5303:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.keyboard=void 0;const r=n(832),a=n(6968),o=n(137);t.keyboard={RegisterPanel:[[r.Markup.button.callback("Продолжить ✅","yes")]],mainPanel:{changeRestaurantKey:r.Markup.button.callback("Изменить шаурмаркет 🏘","changeRestaurant"),menuKey:r.Markup.button.callback("Меню 🍱","menu"),bonusKey:r.Markup.button.callback("Бонусный счёт 💸","bonus"),addBonusKey:r.Markup.button.callback("Добавить бонусный счёт 💸","addBonus"),adminKey:r.Markup.button.callback("Админка ⌨️","adminPanelA"),promo:r.Markup.button.callback("Применить промокод 🃏","promoMain")},order:e=>{const t=(0,a.productsSum)(e.session.order);return r.Markup.button.callback(`🛒 Корзина - ${t}₽`,"order")},order2:e=>{const t=(0,a.productsSum)(e.session.order);return r.Markup.button.callback(`🛒 Корзина - ${t}₽`,"order")},order3:e=>((0,a.productsSum)(e.session.order),r.Markup.button.callback("🛒 Корзина","order")),next:r.Markup.button.callback("Продолжить","next"),nextNn:r.Markup.button.callback("Продолжить без номера","next"),back:r.Markup.button.callback("Назад ⏪","back"),backT:r.Markup.button.callback("Назад ⏪","backT"),backB:r.Markup.button.callback("Назад ⏪","backB"),backToMain:r.Markup.button.callback("В меню выбора ⏪","back"),counter:(e,t,n,a)=>e>1?[r.Markup.button.callback("-",t+":"+(e-1)+":"+n),r.Markup.button.callback(e+" шт",":"),r.Markup.button.callback("+",t+":"+(e+1)+":"+n)]:[r.Markup.button.callback("⠀",":"),r.Markup.button.callback(e+" шт",":"),r.Markup.button.callback("+",t+":"+(e+1)+":"+n)],menu:{product:{addToOrder:e=>r.Markup.button.callback(`Добавить 🛒 (+ ${e} руб)`,"plusOrder"),exceptions:r.Markup.button.callback("Состав ✏️","exceptions:start"),addDop:r.Markup.button.callback("Добавки 🥓","dop:start"),exit:r.Markup.button.callback("Отмена 🚫 (назад)","backT")}},orderPanel:{editOrder:r.Markup.button.callback("Редактировать заказ 📝","edit"),promo:r.Markup.button.callback("Применить промокод 🃏","promo"),pay:r.Markup.button.callback("Оплатить 💳","pay"),checkout:r.Markup.button.callback("Оформить ❇️","checkout"),clear:r.Markup.button.callback("Очистить корзину 🚫 ","clear"),save:r.Markup.button.callback("Сохранить 💾","save"),delete:e=>r.Markup.button.callback("Удалить блюдо 🚫","del:"+e)},checkout:{yes:r.Markup.button.callback("Подтвердить ✅","yes"),return:r.Markup.button.callback("Вернуться в корзину ⏮","backT"),here:r.Markup.button.callback("В зале 🍱","here"),take:r.Markup.button.callback("На вынос 🛍","take"),soon:r.Markup.button.callback("Как можно скорей ⚡️","soon"),inTime:r.Markup.button.callback("Ко времени ⏰","inTime"),noComment:r.Markup.button.callback("Без комментария ❌","noComment"),payInRestaurant:r.Markup.button.callback("При получении 💸","payInRestaurant"),payBonus:(e,t)=>e<t?r.Markup.button.callback(`Бонусы ${e} 🎁 + ${t-e} руб при получении`,"bonusPay:"+e):r.Markup.button.callback(`Бонусы (${t}) 100% 🎁`,"bonusPay:"+t),payOnline:r.Markup.button.callback("Картой (онлайн) 💳","payOnline"),payButton:e=>r.Markup.button.pay("Оплатить 💳 до "+e),payCancel:e=>r.Markup.button.callback("Отменить заказ ❌","cancelOrd:"+e),timeCounter:e=>{let{amountH:n,amountM:a,workTime:o}=e;const i=(new Date).getHours(),[s,d,c]=(new Date).toLocaleDateString("ru").split("."),u=new Date(Number(c),Number(d)-1,Number(s),Number(n),Number(a)).getTime(),l=(new Date).getTime()+18e5,p=[];n>o.start&&n>i?u-36e5<l?p.push(r.Markup.button.callback("⠀",":")):p.push(r.Markup.button.callback("-","time:"+(n-1)+":"+a)):p.push(r.Markup.button.callback("⠀",":")),p.push(r.Markup.button.callback(n+" час",":")),n<o.end-1?p.push(r.Markup.button.callback("+","time:"+(n+1)+":"+a)):p.push(r.Markup.button.callback("⠀",":"));const m=[];return u-6e5<l?m.push(r.Markup.button.callback("⠀",":")):m.push(r.Markup.button.callback("-10","time:"+n+":"+(a-10))),m.push(r.Markup.button.callback(a+" мин",":")),n===o.end-1&&a+10>59?m.push(r.Markup.button.callback("⠀",":")):m.push(r.Markup.button.callback("+10","time:"+n+":"+(a+10))),[p,m,[r.Markup.button.callback("Подтвердить ✅","yes:"+n+":"+a)],[t.keyboard.checkout.return]]}},changeStatus:{accept:e=>r.Markup.button.callback("Готовим ✅","ordCS:Accept:"+e),ready:e=>r.Markup.button.callback("Приготовлен ✅","ordCS:Ready:"+e),placed:e=>r.Markup.button.callback("Выдан ✅","ordCS:Placed:"+e),cancel:e=>r.Markup.button.callback("Отменить ❌","ordCS:Cancel:"+e),repeat:e=>r.Markup.button.callback("Повторить заказ 🌯","repeatOrder:"+e),newOrder:r.Markup.button.callback("Новый заказ 🍽","newOrder")},adminPanel:{main:{parsingKey:r.Markup.button.callback("Парсинг меню","adminParseMenuA"),workTimeKey:r.Markup.button.callback("Время работы","changeWorkTimeA"),stopRest:r.Markup.button.callback("Стоп ресторан","stopRestA"),stopList:r.Markup.button.callback("Стоп-лист меню","stopListA")},workingTime:e=>{const{start:t,end:n,restId:a}=e,o=[];t-1<=0||t-1>=n?o.push(r.Markup.button.callback("⠀",":")):o.push(r.Markup.button.callback("-","changeTime:"+(t-1)+":"+n+":"+a)),o.push(r.Markup.button.callback(t+" час.",":")),t+1>23||t+1>=n?o.push(r.Markup.button.callback("⠀",":")):o.push(r.Markup.button.callback("+","changeTime:"+(t+1)+":"+n+":"+a));const i=[];return n-1<=0||n-1<=t?i.push(r.Markup.button.callback("⠀",":")):i.push(r.Markup.button.callback("-","changeTime:"+t+":"+(n-1)+":"+a)),i.push(r.Markup.button.callback(n+" час.",":")),n+1>23||n+1<=t?i.push(r.Markup.button.callback("⠀",":")):i.push(r.Markup.button.callback("+","changeTime:"+t+":"+(n+1)+":"+a)),[o,i,[r.Markup.button.callback("Подтвердить ✅","save:"+t+":"+n+":"+a)]]}},rate:{grades:e=>[r.Markup.button.callback("1️⃣","rateOrder:1:"+e),r.Markup.button.callback("2️⃣","rateOrder:2:"+e),r.Markup.button.callback("3️⃣","rateOrder:3:"+e),r.Markup.button.callback("4️⃣","rateOrder:4:"+e),r.Markup.button.callback("5️⃣","rateOrder:5:"+e)],rate_noLike:[[r.Markup.button.callback("Время обслуживания","rCaus:1")],[r.Markup.button.callback("Качество еды","rCaus:2")],[r.Markup.button.callback("Чистота","rCaus:3")],[r.Markup.button.callback("Что-то не так с заказом","rCaus:4")],[r.Markup.button.callback("Работа бота","rCaus:5")],[r.Markup.button.callback("Другое","rCaus:6")]],rate_like:[[r.Markup.button.callback("Время обслуживания","rCaus:1")],[r.Markup.button.callback("Качество еды","rCaus:2")],[r.Markup.button.callback("Работа бота","rCaus:5")],[r.Markup.button.callback("Другое","rCaus:6")]],rate_br:(e,t)=>{const n=[];try{o.rateCauses.forEach(((a,o)=>{a.grade<=t&&a.gradeEnd>=t&&n.push([r.Markup.button.callback(a.text+(e.includes(o.toString())?" ☑️":""),"rCaus:"+o.toString())])}))}catch(e){console.log(e)}return n.push([r.Markup.button.callback("Комментарий ✍️","comment"),r.Markup.button.callback("Готово 👌","save")]),n},no_comment:r.Markup.button.callback("Без комментария 🙅‍♀️","noComment")},hideThisMessage:r.Markup.button.callback("Прочитано | Убрать сообщение ❌ ","hideThisMessage")}},3245:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AddBonusAccountPanel=void 0;const a=n(832);t.AddBonusAccountPanel=e=>r(void 0,void 0,void 0,(function*(){try{try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("enterPhoneNumber",{hat:e.i18n.t("hat")}),Object.assign({},a.Markup.keyboard([[a.Markup.button.contactRequest("Поделится контактом 📲")]]).oneTime().resize()))).message_id}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},5189:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),a(n(3245),t)},2336:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AdminPanel=void 0;const a=n(832),o=n(9042),i=n(5303);t.AdminPanel=e=>r(void 0,void 0,void 0,(function*(){try{const t=yield(0,o.getAdminLvl)(e.from.id);if(!(t>0))return;yield e.editMessageText(e.i18n.t("admin-panel",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard([t>=2?[i.keyboard.adminPanel.main.parsingKey]:[],t>=2?[i.keyboard.adminPanel.main.workTimeKey]:[],[i.keyboard.adminPanel.main.stopRest],[i.keyboard.adminPanel.main.stopList],[i.keyboard.back]]))),yield e.scene.leave(),yield e.scene.enter("admin")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},1978:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),a(n(2336),t)},3742:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.MainPanel=void 0;const a=n(832),o=n(5303),i=n(9042);t.MainPanel=(e,t=!1)=>r(void 0,void 0,void 0,(function*(){try{if(!e.from)return;const n=[[o.keyboard.mainPanel.changeRestaurantKey]];e.session.order?n.push([o.keyboard.mainPanel.menuKey,o.keyboard.order(e)]):n.push([o.keyboard.mainPanel.menuKey]),e.session.phone?n.push([o.keyboard.mainPanel.bonusKey]):n.push([o.keyboard.mainPanel.addBonusKey]),(yield(0,i.getAdminLvl)(e.from.id))>=1&&n.push([o.keyboard.mainPanel.adminKey]),e.session.hasOwnProperty("restaurant_id")||(e.session.restaurant_id=0);const r=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0];if(t)yield e.editMessageText(e.i18n.t("mainPanel",{restaurant:r,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(n)));else{if(e.session.id_mes_panel)try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("mainPanel",{restaurant:r,hat:e.i18n.t("hat")}),Object.assign({},a.Markup.inlineKeyboard(n)))).message_id}return e.wizard&&(yield e.scene.leave()),yield e.scene.enter("panel")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},5703:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.AdditivesCard=void 0;const a=n(832),o=n(5303);t.AdditivesCard=(e,t)=>r(void 0,void 0,void 0,(function*(){try{const[,n]=e.callbackQuery.data.split(":"),r=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].products.filter((n=>t?e.wizard.state.data.viewProduct.exceptionsProducts.includes(n.product_id):e.wizard.state.data.viewProduct.additivesProducts.includes(n.product_id)));if("start"!==n)if(e.wizard.state.data.viewProduct.additives.find((e=>e.product_id===n))){const r=e.wizard.state.data.viewProduct.additives.findIndex((e=>e.product_id===n));e.wizard.state.data.viewProduct.additives.splice(r,1),t?e.wizard.state.data.additivesCounter:e.wizard.state.data.additivesCounter-=1}else{if(e.wizard.state.data.additivesCounter>3&&!t)return e.answerCbQuery(e.i18n.t("additives-much"),{show_alert:!0});e.wizard.state.data.viewProduct.additives.push(r.find((e=>e.product_id===n))),t?e.wizard.state.data.additivesCounter:e.wizard.state.data.additivesCounter+=1}const i=e.wizard.state.data.viewProduct.additives,s=(e,n)=>i.find((t=>t.product_id===e))?" ✅ "+(t?"":`+ ${n} руб`):" "+(t?"":`| ${n} руб`),d=r.map((e=>[a.Markup.button.callback(e.name+s(e.product_id,e.price),"dop:"+e.product_id)]));return d.push([o.keyboard.orderPanel.save]),yield e.editMessageText(e.i18n.t("menuPanel-adds",{product:e.wizard.state.data.viewProduct,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(d))),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},7260:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.MenuPanel=void 0;const a=n(832),o=n(8542),i=n(5303);t.MenuPanel=e=>r(void 0,void 0,void 0,(function*(){try{const t=(yield e.config.find({name:"categories"}).toArray())[0].data.filter((e=>e.config.show)),n=(0,o.CreateMultilineKeyboard)(t,"category","id",1,"name"),r=[];return n.map((e=>{r.push(e)})),e.session.order?r.push([i.keyboard.order(e),i.keyboard.back]):r.push([i.keyboard.back]),yield e.editMessageText(e.i18n.t("menuPanel",{hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(r))),yield e.scene.leave(),yield e.scene.enter("menu")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},5088:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ProductCard=void 0;const a=n(832),o=n(5303),i=n(6968);t.ProductCard=e=>r(void 0,void 0,void 0,(function*(){try{if(!e.callbackQuery||!e.callbackQuery.data)return;const[,t,n]=e.callbackQuery.data.split(":");if(e.wizard.state.data)t&&(e.wizard.state.data.viewProduct.amount=Number(t));else{const t=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0].products.find((e=>e.product_id===n));e.wizard.state.data={additivesCounter:0,viewProduct:Object.assign(Object.assign({},t),{amount:1,additives:[]})}}const r=e.wizard.state.data.viewProduct,s=[o.keyboard.counter(r.amount,"add",n,"set")];r.additivesProducts?r.exceptionsProducts?(s.push([o.keyboard.menu.product.addDop,o.keyboard.menu.product.exceptions]),s.push([o.keyboard.menu.product.exit])):s.push([o.keyboard.menu.product.addDop,o.keyboard.menu.product.exit]):r.exceptionsProducts?s.push([o.keyboard.menu.product.exceptions,o.keyboard.menu.product.exit]):s.push([o.keyboard.menu.product.exit]),s.push([o.keyboard.menu.product.addToOrder((0,i.productsSum)([r]))]),yield e.editMessageText(e.i18n.t("menuPanel-viewProduct",{product:r,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(s))),e.answerCbQuery()}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},3297:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),a(n(7260),t)},3144:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.OrderPanel=void 0;const a=n(832),o=n(5303),i=n(6968),s=n(9184),d=n(8370);t.OrderPanel=(e,t=!0)=>r(void 0,void 0,void 0,(function*(){try{if(!e.session.order)return yield e.panel.MainPanel(e,!0);const n=JSON.parse(JSON.stringify(e.session.order));if(e.session.order=yield(0,d.updatePrices)(e.session.order,e.session.restaurant_id),(0,i.productsSum)(n)!==(0,i.productsSum)(e.session.order))return yield e.answerCbQuery("Внимание✋\n Цены, продукты или добавки в корзине изменились\n\nНажмите ещё раз и проверьте изменения перед заказом",{show_alert:!0}),e.session.order.length<1?(delete e.session.order,yield e.panel.MainPanel(e)):yield e.panel.OrderPanel(e);if(e.session.promo_order){const t=yield(0,i.productsSum)(e.session.order);if(t<(yield e.config.find({name:"promo"}).toArray())[0].data.find((t=>t.name===e.session.promo_order)).condition){yield e.answerCbQuery(e.i18n.t("orderPanel-promo-answer"),{show_alert:!0});const t=e.session.order.findIndex((e=>e.promo));if(e.session.order.splice(t,1),delete e.session.promo_order,!e.session.order.length)return delete e.session.order,yield e.panel.MainPanel(e)}}const r={orderDishes:yield(0,s.productsToString)(e.session.order),fullPrice:yield(0,i.productsSum)(e.session.order)},c=[[o.keyboard.orderPanel.editOrder],[o.keyboard.orderPanel.checkout,o.keyboard.back]],u=(yield e.dbRestaurants.find({_id:e.session.restaurant_id}).toArray())[0];if(t)yield e.editMessageText(e.i18n.t("orderPanel",{order:r,restaurant:u,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(c)));else{if(e.session.id_mes_panel)try{yield e.telegram.deleteMessage(e.from.id,e.session.id_mes_panel)}catch(t){try{yield e.telegram.editMessageText(e.from.id,e.session.id_mes_panel,"0",e.i18n.t("hat-nHTML"))}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("orderPanel",{order:r,restaurant:u,hat:e.i18n.t("hat")}),Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(c)))).message_id}return yield e.answerCbQuery(),yield e.scene.leave(),yield e.scene.enter("order")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},5116:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),a(n(3144),t)},6606:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),a(n(3742),t)},7486:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.RegisterPanel=void 0;const a=n(832),o=n(5303);t.RegisterPanel=e=>r(void 0,void 0,void 0,(function*(){try{return e.session.id_mes_panel=(yield e.replyWithHTML(e.i18n.t("registerPanel",{hat:e.i18n.t("hat")}),Object.assign({},a.Markup.inlineKeyboard(o.keyboard.RegisterPanel)))).message_id,yield e.scene.enter("register")}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},2338:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var a=Object.getOwnPropertyDescriptor(t,n);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,a)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),a(n(7486),t)},5708:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.messages=void 0,t.messages={rateOrder:"Спасибо за заказ 🖤\n\nПредлагаем поставить нам оценку: ",changeStatusNew:(e,t,n)=>`<b>Новый заказ #<code>${e._id}</code></b>\n${e.fp_number?"\nНомер заказа в frontPad: <b>"+e.fp_number+"</b>\n":""}\nСтатус: <b>${e.status}</b>\n\nПриготовить: <b>${e.cookingTime.length>5?e.cookingTime:e.cookingTime+" ⏰"}</b>\nВыдать ${e.take?"в пакете (<b>на вынос</b>)":"на подносе (<b>в зале</b>)"}\n\nСостав:\n${n}\n\nИтого: <b>${e.sum}</b> руб\n${e.bonusSum>0?"(в том числе оплачено бонусами <b>"+e.bonusSum+"</b> руб)\n":""}\n${e.comment.length?"Комментарий: <b>"+e.comment.toUpperCase()+"</b>❗️\n":""}\nTelegram клиента: ${e.client.username?"@"+e.client.username+" | ":" "}<a href="tg://user?id=${e.client.chatId}">профиль</a>\nТелефон: +7<code>${e.client.number.slice(1,11)}</code>`,changeStatusClient:(e,t,n)=>`  ✴️ Заказ <b>${e.status}</b>!\n\n🌯 <b>Бостон Шаурма</b> | Заказ #${e._id}\n\nВремя приготовления: ${e.cookingTime}\nСумма заказа: ${e.sum} руб\n${e.bonusSum>0?"(в том числе оплачено бонусами <b>"+e.bonusSum+"</b> руб)\n":""}\n\nСостав:\n${n}\n\nРесторан: <i>${t.address}</i>\n\n${"получен"!==e.status&&"отменён"!==e.status?`Если остались вопросы по заказу - звоните: ${t.phone}`:""}\n${"получен"===e.status||"отменён"===e.status?"Можете оформить новый заказ прямо сейчас - /menu":""}`}},137:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.rateCauses=void 0,t.rateCauses=[{text:"Долгое обслуживание",grade:0,gradeEnd:0},{text:"Долгое обслуживание",grade:4,gradeEnd:1},{text:"Не полный заказ",grade:4,gradeEnd:1},{text:"Не вкусная еда",grade:4,gradeEnd:1},{text:"Плохой сервис",grade:4,gradeEnd:1},{text:"Плохой сервис",grade:0,gradeEnd:0},{text:"Быстрое обслуживание",grade:5,gradeEnd:5},{text:"Отличный сервис",grade:5,gradeEnd:5},{text:"Вкусная еда",grade:5,gradeEnd:5}]},5692:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.rateOrder=void 0;const a=n(832),o=n(7665),i=n(5303),s=n(5708);t.rateOrder=e=>r(void 0,void 0,void 0,(function*(){try{const t=e.take?45:25;setTimeout((()=>r(void 0,void 0,void 0,(function*(){yield o.bot.telegram.sendMessage(e.client.chatId,s.messages.rateOrder,Object.assign({parse_mode:"HTML"},a.Markup.inlineKeyboard(i.keyboard.rate.grades(e._id))))}))),6e4*t)}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},2387:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sendOrder=void 0;const o=a(n(2167)),i=a(n(8941)),s=n(698);t.sendOrder=(e,t,n)=>r(void 0,void 0,void 0,(function*(){try{const a=(yield e.dbRestaurants.find({_id:t.restaurant_id}).toArray())[0];if(t.status="оформлен",a.fpIntegration){const[s,d,c,u]=(e=>{const t=[],n=[],r=[],a={};return e.forEach((e=>{if(t.push(e.product_id),n.push(e.amount.toString()),r.push(e.price.toString()),e.additives){const o=(t.length-1).toString();e.additives.forEach((i=>{t.push(i.product_id),n.push(e.amount.toString()),r.push(i.price.toString()),a[t.length-1]=o}))}})),[t,n,r,a]})(t.products),l=new Date,p=new i.default;p.append("secret",(yield e.dbRestaurants.find({_id:t.restaurant_id}).toArray())[0].frontPad);for(let e in s)p.append(`product[${e}]`,s[e]);for(let e in d)p.append(`product_kol[${e}]`,d[e]);if(u)for(let e in u)p.append(`product_mod[${e}]`,u[e]);for(let e in c)p.append(`product_price[${e}]`,c[e]);p.append("phone","8"+t.client.number.toString().slice(1,11));const m=`${t.cookingTime.length>6?"":"Приготовить к "+t.cookingTime+" | "}${t.comment?t.comment+" | ":""}#${t._id}`;p.append("descr",m),p.append("tags[0]",t.take?317:318),p.append("hook_status[0]",19),p.append("hook_status[1]",20),p.append("hook_status[2]",10),p.append("hook_url",`http://${process.env.SERVER_IP}:${process.env.SERVER_PORT}/api/changeStatus`),p.append("channel",363),t.client.first_name&&p.append("name",t.client.first_name),t.bonusSum&&t.bonusSum>0&&p.append("score",t.bonusSum),t.restaurant_id&&p.append("affiliate",t.restaurant_id.toString()),"Как можно скорее"!==t.cookingTime&&p.append("datetime",`${l.toLocaleDateString("se-SE")} ${t.cookingTime}:00`),yield(0,o.default)({method:"post",url:"https://app.frontpad.ru/api/index.php?new_order",data:p,headers:{"Content-type":"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.143 YaBrowser/22.5.0.1792 Yowser/2.5 Safari/537.36"},responseType:"text"}).then((o=>r(void 0,void 0,void 0,(function*(){"error"===o.data.result?n?n.telegram.sendMessage(a.chat_id,`Заказ #${t._id} не смог отправится в FRONTPAD. Пробейте самостоятельно.`,{parse_mode:"HTML"}):e.telegram.sendMessage(a.chat_id,`Заказ #${t._id} не смог отправится в FRONTPAD. Пробейте самостоятельно.`,{parse_mode:"HTML"}):(t.fp_id=o.data.order_id,t.fp_number=o.data.order_number)})))).catch((()=>r(void 0,void 0,void 0,(function*(){n?n.telegram.sendMessage(a.chat_id,`Заказ #${t._id} не смог отправится в FRONTPAD. Пробейте самостоятельно.`,{parse_mode:"HTML"}):e.telegram.sendMessage(a.chat_id,`Заказ #${t._id} не смог отправится в FRONTPAD. Пробейте самостоятельно.`,{parse_mode:"HTML"})}))))}t.client.message_id?n?yield n.telegram.editMessageText(t.client.chatId,t.client.message_id,"1","обновление нового заказа...",{parse_mode:"HTML"}):(yield e.telegram.editMessageText(t.client.chatId,t.client.message_id,"1","обновление нового заказа...",{parse_mode:"HTML"}),delete e.session.id_mes_panel):t.client.message_id=n?(yield n.telegram.sendMessage(t.client.chatId,"загрузка нового заказа...",{parse_mode:"HTML"})).message_id:(yield e.telegram.sendMessage(t.client.chatId,"загрузка нового заказа...",{parse_mode:"HTML"})).message_id,n?yield n.telegram.sendMessage(a.chat_id,"загрузка нового заказа...",{parse_mode:"HTML"}).then((e=>{if(t.client.restaurant_message_id=e.message_id,a.fpIntegration){if(!t.fp_id)try{n.telegram.pinChatMessage(e.chat.id,e.message_id)}catch(e){}}else try{n.telegram.pinChatMessage(e.chat.id,e.message_id,{disable_notification:!0})}catch(e){}})):yield e.telegram.sendMessage(a.chat_id,"загрузка нового заказа...",{parse_mode:"HTML"}).then((n=>{if(t.client.restaurant_message_id=n.message_id,a.fpIntegration){if(!t.fp_id)try{e.telegram.pinChatMessage(n.chat.id,n.message_id)}catch(e){}}else try{e.telegram.pinChatMessage(n.chat.id,n.message_id,{disable_notification:!0})}catch(e){}})),yield e.dbOrders.updateOne({_id:t._id},{$set:t}),yield(0,s.changeStatus)({status:2,orderNumber:t._id})}catch(e){console.error(`${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))},8370:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.updatePrices=void 0;const a=n(7665);t.updatePrices=(e,t)=>r(void 0,void 0,void 0,(function*(){try{const n=JSON.parse(JSON.stringify(e)),r=(yield a.bot.context.dbRestaurants.find({_id:t}).toArray())[0].products;return n.filter((e=>{const t=r.find((t=>t.product_id===e.product_id));return!!t&&t.name===e.name&&!t.stop&&!e.promo})).map((e=>{const t=r.find((t=>t.product_id===e.product_id));return t.price!==e.price&&(e.price=t.price),e.additives&&(e.additives=e.additives.filter((e=>{const t=r.find((t=>t.product_id===e.product_id));return!!t&&!t.stop&&t.name===e.name})).map((e=>{const t=r.find((t=>t.product_id===e.product_id));return t.price!==e.price&&(e.price,t.price),e}))),e}))}catch(e){return console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e),[]}}))},6005:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(6309),i=new a.Composer;i.command("start",(e=>r(void 0,void 0,void 0,(function*(){yield(0,o.startSupBot)(e)})))),e.exports=i},7847:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.composers=void 0,t.composers=e=>{e.use(n(6005))}},2993:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.setupI18sup=void 0;const a=r(n(1017)),o=new(r(n(6761)).default)({directory:a.default.resolve(__dirname,"../locales"),useSession:!1,allowMissing:!1,defaultLanguage:"ru"});t.setupI18sup=e=>{e.use(o.middleware())}},669:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ScenesStage=void 0;const r=n(832);t.ScenesStage=new r.Scenes.Stage([n(1858)])},1858:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=n(832),o=n(6309),i=new a.Composer;i.action(/.+/,(e=>r(void 0,void 0,void 0,(function*(){try{let t=`<b>Открылся новый чат обращения!</b>\n\n<a href="tg://user?id=${e.from.id}">Клиент ${e.from.first_name}</a>${e.from.username?" @"+e.from.username:""}`;const n=(yield e.originalSession.find({key:e.from.id+":"+e.from.id}).toArray())[0].data;n&&n.phone&&(t+=` (+7<code>${n.phone.slice(1,11)}</code>)`),"otherOrder"===e.callbackQuery.data?e.editMessageText("<b>Вы начали новое чат-обращение</b>\n\nОператор ответит вам сразу, как только освободится\n\nЗадайте вопрос по другому заказу: ",{parse_mode:"HTML"}):"otherQ"===e.callbackQuery.data?e.editMessageText("<b>Вы начали новое чат-обращение</b>\n\nОператор ответит вам сразу, как только освободится\n\nЗадайте ваш вопрос: ",{parse_mode:"HTML"}):(e.editMessageText(`<b>Вы начали новое чат-обращение</b>\n\nОператор ответит вам сразу, как только освободится\n\nЗадайте ваш вопрос по заказу ${e.callbackQuery.data}: `,{parse_mode:"HTML"}),t+=` по заказу №<code>${e.callbackQuery.data}</code>`);const r={_id:Math.floor(1e5+9e5*Math.random()),chatId:e.from.id,status:"open",messages:[]};return e.session.ticket=r._id,yield e.tickets.insertOne(r),yield e.telegram.sendMessage(process.env.SUPPORT_CHAT,t+`\nОбращение <code>#${r._id}</code>`,{parse_mode:"HTML"}).then((t=>{e.tickets.updateOne({_id:r._id},{$push:{messages:{sender:"КЛ",message:"начал обращение",mid:0}}})})),yield e.wizard.next()}catch(e){console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e)}}))));const s=new a.Composer;s.on("text",(e=>r(void 0,void 0,void 0,(function*(){try{if(!e.session.ticket&&"/start"!==e.message.text)return e.scene.leave(),yield e.replyWithHTML("Если хотите отправить <b>новое обращение</b>, то введите команду <b>/start</b>");if("/start"===e.message.text)return e.session.ticket?(yield e.tickets.updateOne({_id:e.session.ticket},{$set:{status:"close"}}),yield e.telegram.sendMessage(process.env.SUPPORT_CHAT,`<a href="tg://user?id=${e.from.id}">Клиент ${e.from.first_name}</a>${e.from.username?" @"+e.from.username:""} закрыл обращение <code>#${e.session.ticket}</code>`,{parse_mode:"HTML"}),e.tickets.updateOne({_id:e.session.ticket},{$push:{messages:{sender:"КЛ",message:"закрыл обращение",mid:0}}}),delete e.session.ticket,(0,o.startSupBot)(e)):(0,o.startSupBot)(e);yield e.forwardMessage(process.env.SUPPORT_CHAT).then((t=>{e.tickets.updateOne({_id:e.session.ticket},{$push:{messages:{sender:"КЛ",message:e.message.text,mid:t.message_id}}})}))}catch(e){console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),s.on("message",(e=>r(void 0,void 0,void 0,(function*(){try{yield e.forwardMessage(process.env.SUPPORT_CHAT).then((t=>{let n="";n=e.message.caption?e.message.caption+" +файл(-ы)":" +файл(-ы)",e.tickets.updateOne({_id:e.session.ticket},{$push:{messages:{sender:"КЛ",message:n,mid:t.message_id}}})}))}catch(e){console.error(`${(new Date).toString()} ${(new Date).toString()}  cant >> ${__filename} error:`,e)}})))),e.exports=new a.Scenes.WizardScene("supportMenu",i,s)},8266:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.supKeyboard=void 0;const r=n(832);t.supKeyboard={mainPanel:e=>{const t=[];return e&&e.data&&e.data.orders&&e.data.orders.length>0&&e.data.orders.forEach(((e,n,a)=>{n>a.length-5&&t.push([r.Markup.button.callback(e,e)])})),t.push([r.Markup.button.callback("Вопрос по другому заказу","otherOrder")]),t.push([r.Markup.button.callback("Вопрос не по заказу","otherQ")]),t},actions:e=>[[r.Markup.button.callback("Последние сообщения","lm:"+e)]]}},6309:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{d(r.next(e))}catch(e){o(e)}}function s(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.startSupBot=void 0;const a=n(832),o=n(8266);t.startSupBot=e=>r(void 0,void 0,void 0,(function*(){try{try{e.deleteMessage()}catch(e){}if(e.message&&e.chat){if(e.chat.id<0)return;const t=(yield e.originalSession.find({key:e.from.id+":"+e.from.id}).toArray())[0];yield e.replyWithHTML("Добро пожаловать в бот-поддержку <b>Бостон шаурмаркет!</b>\n\nВыберите заказ по которому у вас возник вопрос:",Object.assign({},a.Markup.inlineKeyboard(o.supKeyboard.mainPanel(t)))),e.session.__scenes&&(yield e.scene.leave()),yield e.scene.enter("supportMenu")}}catch(e){console.log("Error support bot >",e)}}))},6968:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.productsSum=void 0,t.productsSum=e=>e.reduce(((e,t)=>{const n=t.additives.reduce(((e,t)=>e+t.price),0);return e+(t.price+n)*t.amount}),0)},9184:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.productsToString=void 0,t.productsToString=e=>e.map((e=>{let t="";e.additives&&(t=e.additives.map(((e,t,n)=>t+1===n.length?`  └<i> ${e.name}</i>\n`:`  ├<i> ${e.name}</i>\n`)).join(""));const n=e.additives.reduce(((e,t)=>e+t.price),0);return`<i>${e.name}</i> | ${e.amount} шт | ${e.amount*(e.price+n)} руб\n${t}`})).join("")},2167:e=>{e.exports=require("axios")},1081:e=>{e.exports=require("dotenv/config")},6860:e=>{e.exports=require("express")},8941:e=>{e.exports=require("form-data")},421:e=>{e.exports=require("google-spreadsheet")},8013:e=>{e.exports=require("mongodb")},8311:e=>{e.exports=require("node-cron")},832:e=>{e.exports=require("telegraf")},6761:e=>{e.exports=require("telegraf-i18n")},8264:e=>{e.exports=require("telegraf-session-mongodb")},1017:e=>{e.exports=require("path")}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r].call(o.exports,o,o.exports,n),o.exports}(()=>{const e=n(8366),t=n(7982),r=n(7665),a=n(2018);(0,t.mongodbConnect)().then((t=>{const n=(0,r.configOrderBot)(t),o=(0,a.configSupportBot)(t);(0,e.configAPI)().listen(process.env.SERVER_PORT,(()=>console.log(`>>> API server success started on ${process.env.SERVER_PORT} port!`))),n.launch().then((()=>console.log(">>> Bot success started! > "+(new Date).toLocaleDateString("ru")+" "+(new Date).toLocaleTimeString("ru")))),o.launch().then((()=>console.log(">>> Bot support success started! > "+(new Date).toLocaleDateString("ru")+" "+(new Date).toLocaleTimeString("ru"))))}))})()})();